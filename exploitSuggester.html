<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exploit Suggester - RootRiot</title>
    <meta name="description" content="Upload Nmap XML, view scan results, and get exploit suggestions">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

    <style>
        /* --- Theme Variables --- */
        :root {
            --bg-darker: #02040a;
            --bg-dark: #0b101b;
            --bg-card: #111625;
            
            --accent-purple: #8b5cf6;
            --accent-yellow: #fbbf24;
            --accent-green: #10b981;
            --accent-blue: #2563eb;
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            --glass-border: rgba(37, 99, 235, 0.5);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Manrope', sans-serif; }
        
        body { 
            background-color: var(--bg-darker); 
            color: var(--text-main); 
            min-height: 100vh; 
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(37, 99, 235, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 25%);
        }

        /* --- Animated Hexagon Grid (Exact Match to Landing Page) --- */
        .hex-grid {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(30deg, #111 12%, transparent 12.5%, transparent 87%, #111 87.5%, #111),
                linear-gradient(150deg, #111 12%, transparent 12.5%, transparent 87%, #111 87.5%, #111),
                linear-gradient(30deg, #111 12%, transparent 12.5%, transparent 87%, #111 87.5%, #111),
                linear-gradient(150deg, #111 12%, transparent 12.5%, transparent 87%, #111 87.5%, #111),
                linear-gradient(60deg, rgba(255,255,255,0.02) 25%, transparent 25.5%, transparent 75%, rgba(255,255,255,0.02) 75%, rgba(255,255,255,0.02)),
                linear-gradient(60deg, rgba(255,255,255,0.02) 25%, transparent 25.5%, transparent 75%, rgba(255,255,255,0.02) 75%, rgba(255,255,255,0.02));
            background-size: 60px 105px;
            background-position: 0 0, 0 0, 30px 52px, 30px 52px, 0 0, 30px 52px;
            opacity: 0.3;
            z-index: -1;
            pointer-events: none;
            animation: gridPulse 8s ease-in-out infinite;
        }
        @keyframes gridPulse {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.02); }
        }

        .glass-nav {
            background: rgba(2, 4, 10, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
            position: sticky; top: 0; z-index: 50;
        }

        .glass-card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--card-shadow);
        }

        .btn-primary {
            background: var(--accent-blue); color: white; padding: 0.5rem 1.2rem; border-radius: 6px; font-weight: 600; transition: all 0.2s;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.3);
        }
        .btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); box-shadow: 0 0 20px rgba(37, 99, 235, 0.5); }

        .btn-outline {
            background: transparent; border: 1px solid var(--glass-border); color: var(--text-muted); padding: 0.5rem 1.2rem;
            border-radius: 6px; font-weight: 600; transition: all 0.2s;
        }
        .btn-outline:hover { border-color: var(--accent-blue); color: white; background: rgba(37, 99, 235, 0.1); }

        .drop-zone {
            border: 2px dashed var(--glass-border); border-radius: 12px; background: rgba(0,0,0,0.2); transition: all 0.2s;
        }
        .drop-zone:hover, .drop-zone.active { border-color: var(--accent-green); background: rgba(16, 185, 129, 0.05); }

        .tool-input {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 8px; padding: 12px;
            color: white; font-family: 'Fira Code', monospace; font-size: 13px; transition: border-color 0.2s;
        }
        .tool-input:focus { outline: none; border-color: var(--accent-blue); }

        .input-tab-button {
            padding: 10px 20px; color: var(--text-muted); font-weight: 600; border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        .input-tab-button:hover { color: white; }
        .input-tab-button.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }

        .main-tab-button {
            padding: 10px 20px; background: rgba(255,255,255,0.05); color: var(--text-muted); border-radius: 8px; margin-right: 10px;
            font-weight: 600; transition: all 0.2s;
        }
        .main-tab-button:hover { background: rgba(255,255,255,0.1); color: white; }
        .main-tab-button.active { background: var(--accent-blue); color: white; box-shadow: 0 0 15px rgba(37, 99, 235, 0.3); }

        .info-item { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 8px; padding: 12px; }
        .info-label { font-size: 10px; text-transform: uppercase; color: var(--accent-blue); font-weight: 700; margin-bottom: 4px; }
        .info-value { color: white; font-weight: 500; font-size: 14px; word-break: break-all; }

        #pocModal { z-index: 1001; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); }
        #pocModal.open { opacity: 1; pointer-events: auto; }
        
        .pill-item {
            font-size: 0.75rem; padding: 4px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3);
            background: transparent; font-weight: 500; display: inline-block; margin-right: 6px; margin-bottom: 6px;
        }
        .pill-item.red { border-color: rgba(248, 113, 113, 0.5); color: #f87171; }
        .pill-item.blue { border-color: rgba(96, 165, 250, 0.5); color: #60a5fa; }

        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .status-open { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .status-closed { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }

        .exploit-group {
            border: 1px solid var(--glass-border); border-radius: 8px; background: rgba(0,0,0,0.2); padding: 16px; margin-bottom: 16px;
        }
        .exploit-header { border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; margin-bottom: 10px; font-weight: 700; color: var(--accent-blue); }
        
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.5s ease forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar for the App */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-darker); }
        ::-webkit-scrollbar-thumb { background: rgba(37, 99, 235, 0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(37, 99, 235, 0.6); }

        /* Specific Scrollbar for Code Block */
        pre::-webkit-scrollbar { height: 8px; }
        pre::-webkit-scrollbar-thumb { background: #4b5563; }
        
        /* Override Highlight.js background to transparent to match modal */
        .hljs { background: transparent !important; padding: 0 !important; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; font-size: 12px; text-transform: uppercase; color: var(--text-muted); border-bottom: 1px solid var(--glass-border); }
        td { padding: 12px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text-main); }
        tr:hover td { background: rgba(255,255,255,0.02); }
    </style>
</head>

<body class="antialiased">

    <div class="hex-grid"></div>

    <nav class="glass-nav">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-20">
                <a href="/" class="text-xl font-bold tracking-tight text-white">
                    Root<span class="text-blue-500">Riot</span>
                </a>
                <div class="flex items-center space-x-4">
                    <a href="index" class="text-gray-400 hover:text-white text-sm font-medium transition-colors">Home</a>
                    <a href="checklist" class="text-gray-400 hover:text-white text-sm font-medium transition-colors">Checklist</a>
                    <a href="toolkit" class="text-gray-400 hover:text-white text-sm font-medium transition-colors">Toolkit</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- PoC Modal (FIXED SCROLLING & OVERFLOW & WRAPPING & COLORS) -->
    <div id="pocModal" class="fixed inset-0 hidden justify-center items-center p-4 transition-opacity duration-300">
        <div class="bg-[#0b101b] border border-blue-500/30 rounded-lg shadow-2xl max-w-4xl w-full flex flex-col overflow-hidden" style="max-height: 85vh;">
            <!-- Modal Header (Fixed with flex-none) -->
            <div class="flex-none flex justify-between items-center p-4 border-b border-gray-700 bg-[#0b101b] z-10">
                <h3 class="text-lg font-semibold text-white">Exploit Code</h3>
                <div class="flex items-center space-x-3">
                    <button id="copyPocButton" class="btn-outline py-1 px-3 text-xs"> <i class="bx bx-copy mr-1"></i> Copy </button>
                    <button id="closePocModal" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
                </div>
            </div>
            
            <!-- Modal Body (Scrollable with flex-1 and min-h-0) -->
            <div class="flex-1 overflow-y-auto min-h-0 bg-[#111625] relative w-full">
                <div id="pocLoading" class="absolute inset-0 flex flex-col justify-center items-center bg-[#111625] z-20 hidden">
                    <i class='bx bx-loader-alt bx-spin text-4xl text-blue-500'></i>
                    <p class="mt-2 text-sm text-gray-400">Fetching exploit code...</p>
                </div>
                
                <!-- Code Container -->
                <!-- 
                     Removed hardcoded language-python.
                     Added break-all and whitespace-pre-wrap for layout safety.
                -->
                <pre id="pocCodeContainer" class="m-0 p-4 text-sm whitespace-pre-wrap break-all"><code id="pocCodeContent" class="font-mono"></code></pre>
                
                <div id="pocError" class="text-red-400 p-4 hidden text-center"></div>
            </div>
        </div>
    </div>

    <main class="container mx-auto px-4 py-12 relative z-10">
        <!-- Uploader -->
        <section id="uploader" class="mb-16 fade-in">
            <div class="text-center max-w-3xl mx-auto mb-10">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-blue-500/30 bg-blue-900/20 backdrop-blur-sm mb-4">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-xs font-medium text-blue-200 uppercase tracking-wider">Analysis Engine</span>
                </div>
                <h1 class="text-4xl font-bold mb-4 text-white">Scan Intelligence & <span class="text-blue-500">Exploitation</span></h1>
                <p class="text-gray-400 text-lg">Upload Nmap XML results to analyze hosts and vulnerabilities.</p>
            </div>

            <div class="glass-card p-1 max-w-4xl mx-auto">
                <div class="flex border-b border-gray-800">
                    <button id="tabUploadFile" class="input-tab-button active w-1/2 text-center"><i class='bx bx-upload mr-2'></i> Upload File</button>
                    <button id="tabPasteContent" class="input-tab-button w-1/2 text-center"><i class='bx bx-paste mr-2'></i> Paste Content</button>
                </div>
                <div class="p-8">
                    <div id="uploadFileContent" class="block">
                        <div id="dropZone" class="drop-zone flex flex-col items-center justify-center py-12 cursor-pointer">
                            <div class="w-16 h-16 rounded-full bg-blue-500/10 flex items-center justify-center mb-4"><i class='bx bx-cloud-upload text-4xl text-blue-400'></i></div>
                            <h3 class="text-lg font-bold text-white mb-2">Drop Nmap XML here</h3>
                            <p class="text-gray-400 text-sm mb-6">or click to browse</p>
                            <input type="file" id="fileInput" class="hidden" accept=".xml,.nmap">
                            <div class="flex gap-4">
                                <button id="browseButton" class="btn-primary">Browse Files</button>
                                <button id="sampleButton" class="btn-outline">Load Sample</button>
                            </div>
                            <div id="uploadProgress" class="hidden w-full max-w-md mt-6">
                                <div class="flex justify-between text-xs text-gray-400 mb-1">
                                    <span>Uploading...</span>
                                    <span id="progressPercent">0%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-1.5">
                                    <div id="progressBar" class="bg-blue-500 h-1.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="pasteContentArea" class="hidden">
                        <textarea id="xmlTextArea" class="tool-input h-64 font-mono text-xs resize-none" placeholder="Paste XML content here..."></textarea>
                        <div class="mt-4 text-right"><button id="processPasteBtn" class="btn-primary"><i class='bx bx-play mr-1'></i> Analyze</button></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Results -->
        <section id="results" class="hidden fade-in">
            <!-- Tab Nav -->
            <div class="flex flex-wrap gap-4 mb-8 border-b border-gray-800 pb-4">
                <button class="main-tab-button active" data-target="scanSummaryContent"><i class='bx bx-grid-alt mr-2'></i> Scan Summary</button>
                <button class="main-tab-button" data-target="exploitSuggesterContent"><i class='bx bx-bug mr-2'></i> Exploit Suggester</button>
                <button id="newScanBtn" class="ml-auto btn-outline text-xs py-2"><i class='bx bx-refresh mr-1'></i> New Scan</button>
            </div>

            <!-- TAB 1: Scan Summary -->
            <div id="scanSummaryContent" class="block">
                <div class="glass-card p-6 mb-8">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                        <i class='bx bx-data text-blue-500'></i> Scan Overview
                        <span id="totalHosts" class="ml-auto text-sm font-normal text-gray-400 bg-gray-800 px-3 py-1 rounded-full">0 Hosts</span>
                    </h3>
                    <div id="scanInfoGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4"></div>
                </div>

                <div class="glass-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-white">Discovered Hosts</h3>
                        <div class="flex gap-2">
                            <input type="text" id="filterInput" class="bg-black/30 border border-gray-700 rounded px-3 py-1 text-xs text-gray-300 focus:outline-none focus:border-blue-500" placeholder="Filter results...">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr>
                                    <th>IP Address</th>
                                    <th>Hostname</th>
                                    <th>Port</th>
                                    <th>Proto</th>
                                    <th>State</th>
                                    <th>Service</th>
                                    <th>Version</th>
                                </tr>
                            </thead>
                            <tbody id="hostResultsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB 2: Exploits -->
            <div id="exploitSuggesterContent" class="hidden">
                <div class="glass-card p-8">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-white mb-2">Vulnerability Analysis</h2>
                        <p class="text-gray-400">Potential exploit paths correlated from CVE databases.</p>
                    </div>
                    <div id="exploitLoader" class="hidden py-12 text-center">
                        <i class='bx bx-loader-alt bx-spin text-4xl text-blue-500'></i>
                        <p class="mt-4 text-gray-400">Correlating CVEs...</p>
                    </div>
                    <div id="exploitList" class="space-y-4"></div>
                </div>
            </div>
        </section>
    </main>

    <footer class="py-8 border-t border-gray-800 mt-12 text-center text-gray-500 text-sm">&copy; 2024 RootRiot.</footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        const appState = { scanData: null };

        document.addEventListener('DOMContentLoaded', () => {
            setupTabs();
            setupUpload();
            setupFilter(); // Init filter listener
            
            const stored = localStorage.getItem('nmapScanData');
            if(stored) {
                try {
                    const data = JSON.parse(stored);
                    renderParsedData(data);
                    const expStored = localStorage.getItem('nmapExploitData');
                    if(expStored) populateExploitSuggesterGrouped(JSON.parse(expStored));
                    showResults();
                } catch(e) { console.error("Load Error", e); }
            }
        });

        function setupTabs() {
            document.getElementById('tabUploadFile').onclick = (e) => {
                switchInputTab(e.target, 'uploadFileContent', 'pasteContentArea');
            };
            document.getElementById('tabPasteContent').onclick = (e) => {
                switchInputTab(e.target, 'pasteContentArea', 'uploadFileContent');
            };

            const mainTabs = document.querySelectorAll('.main-tab-button');
            mainTabs.forEach(btn => {
                btn.onclick = () => {
                    mainTabs.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const target = btn.dataset.target;
                    document.getElementById('scanSummaryContent').classList.add('hidden');
                    document.getElementById('exploitSuggesterContent').classList.add('hidden');
                    document.getElementById(target).classList.remove('hidden');
                }
            });
        }

        function switchInputTab(btn, showId, hideId) {
            document.querySelectorAll('.input-tab-button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(hideId).classList.add('hidden');
            document.getElementById(showId).classList.remove('hidden');
        }

        function setupUpload() {
            const fileInput = document.getElementById('fileInput');
            document.getElementById('browseButton').onclick = () => fileInput.click();
            fileInput.onchange = (e) => handleFile(e.target.files[0]);
            
            const dropZone = document.getElementById('dropZone');
            dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('active'); };
            dropZone.ondragleave = () => dropZone.classList.remove('active');
            dropZone.ondrop = (e) => {
                e.preventDefault();
                dropZone.classList.remove('active');
                handleFile(e.dataTransfer.files[0]);
            };

            document.getElementById('processPasteBtn').onclick = () => {
                const content = document.getElementById('xmlTextArea').value;
                if(content) processXMLContent(content, 'pasted.xml');
            };

            document.getElementById('sampleButton').onclick = loadSample;
            document.getElementById('newScanBtn').onclick = resetApp;
            
            // Close Modal logic
            document.getElementById('closePocModal').onclick = () => {
                const modal = document.getElementById('pocModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };
            
            // Close modal on outside click
            document.getElementById('pocModal').onclick = (e) => {
                if(e.target.id === 'pocModal') {
                    e.target.classList.add('hidden');
                    e.target.classList.remove('flex');
                }
            };

            document.getElementById('copyPocButton').onclick = () => {
                const code = document.getElementById('pocCodeContent').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    const btn = document.getElementById('copyPocButton');
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = `<i class='bx bx-check mr-1'></i> Copied`;
                    setTimeout(() => btn.innerHTML = originalHtml, 2000);
                });
            };
        }

        function setupFilter() {
            document.getElementById('filterInput').addEventListener('input', (e) => {
                if(!appState.scanData) return;
                const term = e.target.value.toLowerCase();
                const filteredHosts = appState.scanData.hosts.filter(h => {
                    // Search hosts (IP/Hostname) or any of their ports/services
                    const hostMatch = h.ip.toLowerCase().includes(term) || h.hostname.toLowerCase().includes(term);
                    const portMatch = h.port.toLowerCase().includes(term) || 
                                      h.service.toLowerCase().includes(term) ||
                                      h.version.toLowerCase().includes(term);
                    return hostMatch || portMatch; 
                });
                renderHostTable(filteredHosts);
            });
        }

        function handleFile(file) {
            if(!file) return;
            document.getElementById('uploadProgress').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('progressBar').style.width = '100%';
                const reader = new FileReader();
                reader.onload = (e) => processXMLContent(e.target.result, file.name);
                reader.readAsText(file);
            }, 500);
        }

        function processXMLContent(xmlString, filename) {
            try {
                const parsed = parseNmapXML(xmlString);
                localStorage.setItem('nmapScanData', JSON.stringify(parsed));
                renderParsedData(parsed);
                fetchExploits(xmlString);
                showResults();
            } catch(e) {
                alert("Error parsing XML: " + e.message);
            }
        }

        function parseNmapXML(xmlContent) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlContent, 'text/xml');
            if(xmlDoc.querySelector('parsererror')) throw new Error("Invalid XML");

            const run = xmlDoc.querySelector('nmaprun');
            const scanInfo = {
                scanner: run.getAttribute('scanner'),
                args: run.getAttribute('args'),
                start: run.getAttribute('startstr'),
                version: run.getAttribute('version')
            };

            const hosts = [];
            xmlDoc.querySelectorAll('host').forEach(h => {
                const state = h.querySelector('status')?.getAttribute('state');
                if(state !== 'up') return;

                const ip = h.querySelector('address[addrtype="ipv4"]')?.getAttribute('addr');
                const hostname = h.querySelector('hostname')?.getAttribute('name') || "";

                h.querySelectorAll('port').forEach(p => {
                    if(p.querySelector('state')?.getAttribute('state') === 'open') {
                        const svc = p.querySelector('service');
                        hosts.push({
                            ip: ip,
                            hostname: hostname,
                            port: p.getAttribute('portid'),
                            proto: p.getAttribute('protocol'),
                            state: 'open',
                            service: svc?.getAttribute('name') || "unknown",
                            version: (svc?.getAttribute('product')||'') + ' ' + (svc?.getAttribute('version')||'')
                        });
                    }
                });
            });

            return { scanInfo, hosts };
        }

        function renderParsedData(data) {
            appState.scanData = data;
            const info = data.scanInfo;
            
            const grid = document.getElementById('scanInfoGrid');
            grid.innerHTML = `
                <div class="info-item"><div class="info-label">Scanner</div><div class="info-value">${info.scanner} ${info.version}</div></div>
                <div class="info-item col-span-2"><div class="info-label">Command</div><div class="info-value text-xs font-mono text-gray-400">${info.args}</div></div>
                <div class="info-item"><div class="info-label">Start</div><div class="info-value text-xs">${info.start}</div></div>
                <div class="info-item"><div class="info-label">Hosts Up</div><div class="info-value text-green-400">${new Set(data.hosts.map(h=>h.ip)).size}</div></div>
                <div class="info-item"><div class="info-label">Ports</div><div class="info-value text-blue-400">${data.hosts.length}</div></div>
            `;
            
            // Initial render of full table
            renderHostTable(data.hosts);
        }

        function renderHostTable(hosts) {
            const tbody = document.getElementById('hostResultsTableBody');
            if(hosts.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-4">No matching hosts found.</td></tr>`;
                return;
            }
            tbody.innerHTML = hosts.map(h => `
                <tr>
                    <td class="font-mono text-blue-300">${h.ip}</td>
                    <td class="text-gray-400">${h.hostname || '-'}</td>
                    <td class="text-white font-bold">${h.port}</td>
                    <td class="uppercase text-xs text-gray-500">${h.proto}</td>
                    <td><span class="status-badge status-open">OPEN</span></td>
                    <td class="text-yellow-400">${h.service}</td>
                    <td class="text-xs text-gray-500 truncate max-w-[150px]">${h.version}</td>
                </tr>
            `).join('');
        }

        async function fetchExploits(xmlContent) {
            const loader = document.getElementById('exploitLoader');
            const list = document.getElementById('exploitList');
            
            loader.classList.remove('hidden');
            list.innerHTML = '';

            try {
                const blob = new Blob([xmlContent], {type: 'text/xml'});
                const formData = new FormData();
                formData.append('nmapFile', blob, 'scan.xml');

                const res = await fetch('https://www.rootriot.xyz/api/process-nmap', {
                    method: 'POST',
                    body: formData
                });

                if(!res.ok) throw new Error('API Error');
                
                const data = await res.json();
                const grouped = data.grouped_results || {};
                localStorage.setItem('nmapExploitData', JSON.stringify(grouped));
                populateExploitSuggesterGrouped(grouped);

            } catch(e) {
                console.error(e);
                list.innerHTML = `<div class="text-red-400 text-center">Failed to fetch exploits. API may be unavailable.</div>`;
            } finally {
                loader.classList.add('hidden');
            }
        }

        function populateExploitSuggesterGrouped(grouped) {
            const list = document.getElementById('exploitList');
            list.innerHTML = '';
            
            const keys = Object.keys(grouped).sort((a,b) => parseInt(a)-parseInt(b));
            
            if(keys.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500">No exploits found.</p>';
                return;
            }

            keys.forEach(key => {
                const data = grouped[key];
                const div = document.createElement('div');
                div.className = 'exploit-group';
                
                let exploitsHTML = '';
                if(data.exploits && data.exploits.length > 0) {
                    exploitsHTML = data.exploits.map(ex => `
                        <li class="bg-[#0b101b] p-3 rounded border border-gray-700 flex justify-between items-center">
                            <span class="text-sm text-gray-300 font-medium">${ex.title}</span>
                            ${ex.relativePath ? `<button onclick="showPoC('${ex.relativePath}')" class="text-xs text-blue-400 hover:underline">POC</button>` : ''}
                        </li>
                    `).join('');
                } else {
                    exploitsHTML = '<p class="text-xs text-gray-500 italic">No direct exploits found.</p>';
                }

                div.innerHTML = `
                    <div class="exploit-header flex justify-between">
                        <span><i class='bx bx-target-lock mr-2'></i> Port ${key}</span>
                        <span class="text-xs font-normal text-gray-400">${data.service} ${data.product || ''}</span>
                    </div>
                    <div class="mb-4">
                        <h4 class="text-xs font-bold text-blue-400 uppercase mb-2">Exploits</h4>
                        <ul class="space-y-2">${exploitsHTML}</ul>
                    </div>
                    <div class="text-xs text-gray-500">Hosts: ${data.hosts.join(', ')}</div>
                `;
                list.appendChild(div);
            });
        }

        function getLanguageFromPath(path) {
            if (!path) return 'language-plaintext';
            const ext = path.split('.').pop().toLowerCase();
            const map = {
                'py': 'language-python',
                'rb': 'language-ruby',
                'sh': 'language-bash',
                'js': 'language-javascript',
                'c': 'language-c',
                'cpp': 'language-cpp',
                'h': 'language-c',
                'txt': 'language-plaintext',
                'md': 'language-markdown',
                'pl': 'language-perl',
                'php': 'language-php'
            };
            return map[ext] || 'language-bash'; 
        }

        async function showPoC(path) {
            if(!path) return;
            const modal = document.getElementById('pocModal');
            const codeEl = document.getElementById('pocCodeContent');
            const loader = document.getElementById('pocLoading');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            codeEl.textContent = '';
            loader.classList.remove('hidden');

            // Reset highlighting and set class
            const langClass = getLanguageFromPath(path);
            codeEl.className = `font-mono ${langClass}`;
            codeEl.removeAttribute('data-highlighted');

            try {
                const res = await fetch(`https://www.rootriot.xyz/api/get-poc?path=${encodeURIComponent(path)}`);
                if (!res.ok) throw new Error("Failed to fetch PoC");
                const data = await res.json();
                
                codeEl.textContent = data.content || 'No code content returned from API.'; 
                hljs.highlightElement(codeEl);
            } catch(e) {
                console.error(e);
                codeEl.textContent = 'Error loading PoC from API.';
            } finally {
                loader.classList.add('hidden');
            }
        }

        function showResults() {
            document.getElementById('uploader').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
        }

        function resetApp() {
            localStorage.removeItem('nmapScanData');
            localStorage.removeItem('nmapExploitData');
            location.reload();
        }

        function loadSample() {
             const sample = `<?xml version="1.0"?><nmaprun scanner="nmap" args="nmap -sV 192.168.1.10" startstr="Today" version="7.94"><host><status state="up"/><address addr="192.168.1.10" addrtype="ipv4"/><ports><port protocol="tcp" portid="21"><state state="open"/><service name="ftp" product="vsftpd" version="2.3.4"/></port><port protocol="tcp" portid="80"><state state="open"/><service name="http" product="Apache" version="2.4.41"/></port></ports></host></nmaprun>`;
            processXMLContent(sample, 'sample.xml');
        }
    </script>
</body>
</html>