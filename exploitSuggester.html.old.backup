<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exploit Suggester - RootRiot</title>
    <meta name="description" content="Upload Nmap XML, view scan results, and get exploit suggestions">

    <link rel="preload" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" as="style">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" as="style">
	<link rel="icon" type="image/x-icon" href="/images/favicon.ico">

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

    <style>
        :root {
            --primary: #002F6C;
            --primary-light: #1a56db;
            --primary-dark: #001a3e;
            --secondary: #10b981;
            --secondary-light: #34d399;
            --secondary-dark: #059669;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
            --neutral: #64748b;
            --glass-light: rgba(255, 255, 255, 0.05);
            --glass-dark: rgba(0, 0, 0, 0.2);
            --transition-fast: 0.2s ease;
            --transition-medium: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 0.4s cubic-bezier(0.33, 1, 0.68, 1);
            --transition-spring: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 12px 24px rgba(0, 0, 0, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Manrope', system-ui, -apple-system, sans-serif;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background: var(--darker);
            color: var(--light);
            min-height: 100vh;
            background-image: radial-gradient(circle at 10% 20%, rgba(26, 86, 219, 0.05) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 20%), radial-gradient(circle at 50% 50%, rgba(15, 23, 42, 0.8) 0%, var(--darker) 100%);
        }

        .container {
            width: 100%;
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        @media (min-width: 640px) {
            .container {
                padding: 0 1.5rem;
            }
        }

        .glass-card {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 16px;
            border: 1px solid var(--glass-light);
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-medium), box-shadow var(--transition-medium);
            will-change: transform, box-shadow;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all var(--transition-medium);
            cursor: pointer;
            border: none;
            outline: none;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 6px rgba(0, 47, 108, 0.25);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 47, 108, 0.3);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.25);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--secondary-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(16, 185, 129, 0.3);
        }

        .btn-outline {
            background: transparent;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .btn-outline:hover:not(:disabled) {
            border-color: var(--primary-light);
            background: rgba(26, 86, 219, 0.1);
            transform: translateY(-2px);
        }

        .gradient-text {
            background: linear-gradient(to right, var(--primary-light), var(--secondary-light));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: inline-block;
        }

        .navbar {
            padding: 1rem 0;
            background: rgba(2, 6, 23, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1000;
            transition: all 0.3s ease;
            position: sticky;
            top: 0;
        }

        .drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            transition: all var(--transition-medium);
            position: relative;
        }

        .drop-zone.active {
            border-color: var(--secondary);
            background: rgba(16, 185, 129, 0.05);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-up,
        .status-open {
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary-light);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-down,
        .status-closed {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-filtered,
        .status-open-filtered {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .status-unknown {
            background: rgba(100, 116, 139, 0.1);
            color: var(--neutral);
            border: 1px solid rgba(100, 116, 139, 0.2);
        }

        .results-container {
            display: none;
        }

        .scan-info-card,
        .host-card {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
        }

        .scan-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .info-item {
            padding: 0.75rem;
            background: var(--glass-light);
            border-radius: 8px;
        }

        .info-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--neutral);
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-weight: 500;
            word-wrap: break-word;
        }

        .service-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            background: rgba(26, 86, 219, 0.1);
            border: 1px solid rgba(26, 86, 219, 0.2);
            color: var(--primary-light);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .port-row:nth-child(odd) {
            background: rgba(255, 255, 255, 0.02);
        }

        #hostResultsTableContainer table th,
        #hostResultsTableContainer table td {
            border-color: var(--glass-light);
            color: var(--light);
        }

        #hostResultsTableContainer table th {
            background-color: rgba(255, 255, 255, 0.05);
        }

        #hostResultsTableContainer table tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        #hostResultsTableContainer .filter-input {
            background: var(--glass-dark);
            border-color: var(--glass-light);
        }

        #hostResultsTableContainer .filter-input::placeholder {
            color: var(--neutral);
        }

        #hostResultsTableContainer .filter-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(26, 86, 219, 0.3);
        }

        .os-match {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--glass-light);
            border-radius: 8px;
        }

        .script-output {
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 0.875rem;
            background: var(--glass-dark);
            padding: 0.75rem;
            border-radius: 8px;
            overflow-x: auto;
        }

        .accordion-header {
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }

        .accordion-header:hover {
            background: var(--glass-light);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-medium) ease-out;
        }

        .accordion-content.open {
            max-height: 1000px;
            transition: max-height var(--transition-medium) ease-in;
        }

        .main-tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px 8px 0 0;
            background: var(--glass-light);
            transition: all var(--transition-medium);
            border: 1px solid transparent;
            border-bottom: none;
            font-weight: 600;
            opacity: 0.7;
        }

        .main-tab-button.active {
            background: rgba(15, 23, 42, 0.8);
            border-color: var(--glass-light);
            border-bottom-color: transparent;
            color: var(--secondary-light);
            opacity: 1;
            transform: translateY(1px);
        }

        .main-tab-content-area {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid var(--glass-light);
            border-radius: 0 0 16px 16px;
            padding: 1.5rem;
            margin-top: -1px;
        }

        .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 8px 8px 0 0;
            background: var(--glass-light);
            transition: all var(--transition-medium);
            border: 1px solid transparent;
            border-bottom: none;
            font-size: 0.875rem;
        }

        .tab-button.active {
            background: rgba(26, 86, 219, 0.1);
            border-color: rgba(26, 86, 219, 0.2);
            color: var(--primary-light);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .host-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .avatar-container {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(26, 86, 219, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            height: 0.5rem;
            overflow: hidden;
            width: 100%;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary-light), var(--secondary-light));
            border-radius: 9999px;
            transition: width 0.5s ease;
        }

        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 8px;
            background: rgba(16, 185, 129, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            box-shadow: var(--shadow-lg);
            transform: translateY(-100%);
            opacity: 0;
            transition: all var(--transition-medium);
            z-index: 1001;
            max-width: 400px;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.error {
            background: rgba(239, 68, 68, 0.9);
        }

        .extra-ports-info {
            background: var(--glass-light);
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.875rem;
        }

        .exploit-group {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            border: 1px solid var(--glass-light);
        }

        .exploit-group h3 {
            color: var(--secondary-light);
            margin-bottom: 0.75rem;
            border-bottom: 1px solid var(--glass-light);
            padding-bottom: 0.5rem;
        }

        .exploit-group h4 {
            color: var(--neutral);
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .exploit-group ul {
            list-style: none;
            padding-left: 0;
        }

        .exploit-group ul li {
            margin-bottom: 0.5rem;
            padding-left: 1.25rem;
            position: relative;
            font-size: 0.875rem;
        }

        .exploit-group ul li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.5em;
            width: 4px;
            height: 4px;
            background: var(--secondary-light);
            border-radius: 50%;
            transform: translateY(-50%);
        }

        .exploit-hosts-list {
            max-height: 150px;
            overflow-y: auto;
            padding: 0.5rem;
            background: var(--glass-dark);
            border-radius: 4px;
            margin-top: 0.5rem;
        }

        .exploit-hosts-list li::before {
            display: none;
        }

        .exploit-hosts-list li {
            padding-left: 0;
        }

        .input-tab-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            color: var(--neutral);
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s ease, border-color 0.2s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
            display: inline-flex;
            align-items: center;
        }

        .input-tab-button:hover {
            color: var(--light);
        }

        .input-tab-button.active {
            color: var(--secondary-light);
            border-bottom-color: var(--secondary);
        }

        .input-tab-content {
            display: none;
        }

        .input-tab-content.active {
            display: block;
        }

        footer {
            background: rgba(2, 6, 23, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding: 3rem 0 1.5rem;
        }

        @media (min-width: 768px) {
            footer {
                padding: 4rem 0 2rem;
            }
        }

        #pocModal {
            z-index: 1001;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-medium) ease-out;
        }

        #pocModal.open {
            opacity: 1;
            pointer-events: auto;
        }

        #pocModal>.bg-gray-800 {
            max-height: 85vh;
            overflow: hidden;
            transform: scale(0.95) translateY(-10px);
            transition: transform var(--transition-smooth), opacity var(--transition-medium);
            opacity: 0;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 16px;
            border: 1px solid var(--glass-light);
            box-shadow: var(--shadow-xl);
        }

        #pocModal.open>.bg-gray-800 {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        #pocModal .modal-content-area {
            min-height: 200px;
            overflow-y: auto;
        }

        #pocModal .hljs {
            background-color: #282c34;
            color: #abb2bf;
            padding: 1em;
            border-radius: 8px;
            display: block;
            overflow-x: auto;
            min-height: 200px;
        }

        body.modal-open {
            overflow: hidden;
        }

        #pocCodeContainer {
            margin: 0;
            padding: 0;
        }

        #pocCodeContainer .hljs::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        #pocCodeContainer .hljs::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        #pocCodeContainer .hljs::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        #pocCodeContainer .hljs::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        #pocCodeContainer .hljs {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) rgba(255, 255, 255, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.1) rgba(255, 255, 255, 0.05);
        }

        @media (max-width: 640px) {
            .scan-info-grid {
                grid-template-columns: 1fr;
            }

            .host-summary {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media print {
            body {
                background: white !important;
                color: black !important;
            }

            .glass-card {
                background: white !important;
                border: 1px solid #eee !important;
                box-shadow: none !important;
            }

            .drop-container,
            .navbar button,
            #clearResultsTop,
            .main-tab-buttons,
            .view-switcher,
            #hostResultsTableContainer .glass-card,
            #paginationControls,
            #pasteContentArea {
                display: none !important;
            }

            .results-container {
                display: block !important;
            }

            .navbar {
                position: static !important;
                background: white !important;
                color: black !important;
                backdrop-filter: none !important;
            }

            .navbar a {
                color: var(--primary) !important;
            }

            .text-gray-300,
            .text-gray-400 {
                color: #555 !important;
            }

            .info-item,
            .os-match,
            .extra-ports-info {
                background: #f9fafb !important;
            }

            .script-output {
                background: #f1f5f9 !important;
                color: #0f172a !important;
            }

            .status-badge {
                border: 1px solid #ccc !important;
            }

            .status-open {
                background: #e6f7f1 !important;
                color: #059669 !important;
            }

            .status-closed {
                background: #fee2e2 !important;
                color: #ef4444 !important;
            }

            .status-filtered {
                background: #fffbeb !important;
                color: #f59e0b !important;
            }

            .gradient-text {
                background: none !important;
                color: var(--primary) !important;
            }

            .port-row:nth-child(odd) {
                background: transparent !important;
            }

            .table,
            #hostResultsTableContainer table {
                border: 1px solid #eee !important;
                width: 100% !important;
            }

            #hostResultsTableContainer table th,
            #hostResultsTableContainer table td {
                border-bottom: 1px solid #eee !important;
                color: black !important;
            }

            #hostResultsTableContainer table th {
                background: #f9fafb !important;
            }

            .table>div:last-child {
                border-bottom: none !important;
            }

            .tab-button.active {
                background: #eef2ff !important;
                color: var(--primary) !important;
            }

            .service-badge {
                background: #eef2ff !important;
                color: var(--primary) !important;
            }

            .avatar-container {
                display: none !important;
            }

            .main-tab-content-area {
                border: none !important;
                padding: 0 !important;
                background: white !important;
            }

            #scanSummaryContent {
                display: block !important;
            }

            #hostResultsCards {
                display: none !important;
            }

            #hostResultsTableContainer {
                display: block !important;
            }

            .tab-content:not(.active) {
                display: none !important;
            }

            #exploitSuggesterContent {
                display: none !important;
            }

            @page {
                size: auto;
                margin: 0.5cm;
            }
        }
    </style>
</head>

<body class="custom-scrollbar flex flex-col min-h-screen">
    <nav class="navbar">
        <div class="container">
            <div class="flex items-center justify-between h-16">
                <a href="/" class="text-2xl font-bold tracking-tight flex-shrink-0"> <span class="text-primary-light">Root</span>Riot </a>
                <div class="hidden md:flex items-center space-x-6 lg:space-x-8"></div>
                <button id="clearResultsTop" class="btn btn-outline py-2 px-4 text-sm hidden md:inline-flex"> <i class="bx bx-refresh mr-2"></i> New Scan </button>
            </div>
        </div>
    </nav>

    <div id="pocModal" class="fixed inset-0 bg-black bg-opacity-70 hidden justify-center items-center z-[1001] p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full flex flex-col max-h-[85vh] overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
                <h3 class="text-lg font-semibold text-white">Proof of Concept</h3>
                <div class="flex items-center space-x-3">
                    <button id="copyPocButton" class="btn btn-outline py-1 px-3 text-xs"> <i class="bx bx-copy mr-1"></i><span class="copy-text"> Copy</span> </button>
                    <button id="closePocModal" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
                </div>
            </div>
            <div class="p-4 overflow-y-auto flex-grow custom-scrollbar modal-content-area">
                <div id="pocLoading" class="text-center py-5 hidden">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary-light"></div>
                    <p class="mt-2 text-sm text-gray-400">Loading PoC...</p>
                </div>
                <div id="modal-content-inner-area" class="flex-grow">
                    <pre id="pocCodeContainer" class="m-0 p-0"><code id="pocCodeContent" class="whitespace-pre break-words"></code></pre>
                </div>
                <div id="pocError" class="text-red-500 hidden p-2 bg-red-900 bg-opacity-30 rounded"></div>
            </div>
        </div>
    </div>

    <main class="container pt-12 md:pt-24 pb-16 flex-grow">
        <section id="uploader" class="mb-12">
            <div class="text-center max-w-3xl mx-auto mb-10"><br><br>
                <h1 class="text-3xl md:text-4xl font-bold mb-4"> Nmap Organizer & <span class="gradient-text">Exploit Suggester</span> </h1>
                <p class="text-gray-300 text-base md:text-lg mb-6"> Upload your Nmap XML file or paste its content to visualize scan results and identify potential vulnerabilities. </p>
            </div>

            <div class="max-w-4xl mx-auto mb-4">
                <div class="flex border-b border-gray-700">
                    <button id="tabUploadFile" class="input-tab-button active"> <i class='bx bx-upload mr-2'></i>Upload File </button>
                    <button id="tabPasteContent" class="input-tab-button"> <i class='bx bx-paste mr-2'></i>Paste Content </button>
                </div>
            </div>

            <div class="max-w-4xl mx-auto">
                <div id="uploadFileContent" class="input-tab-content active">
                    <div class="drop-container">
                        <div id="dropZone" class="drop-zone flex flex-col items-center justify-center py-12 px-4 text-center">
                            <div class="mb-4 w-16 h-16 rounded-full bg-primary bg-opacity-10 flex items-center justify-center"> <i class="bx bx-upload text-4xl text-primary-light"></i> </div>
                            <h3 class="text-xl font-semibold mb-2">Upload Nmap XML File</h3>
                            <p class="text-gray-400 max-w-md mb-6"> Drag and drop your file here, or click to browse </p>
                            <input type="file" id="fileInput" class="hidden" accept=".xml, application/xml, text/xml" />
                            <div class="flex flex-col sm:flex-row gap-4"> <button id="browseButton" class="btn btn-primary"> <i class="bx bx-folder-open mr-2"></i> Browse Files </button> <button id="sampleButton" class="btn btn-outline"> <i class="bx bx-test-tube mr-2"></i> Load Sample Data </button> </div>
                            <div id="uploadProgress" class="w-full max-w-md mt-8 hidden">
                                <div class="flex justify-between mb-2"> <span id="fileName" class="text-sm font-medium text-gray-300 truncate"></span> <span id="fileSize" class="text-sm text-gray-400 flex-shrink-0 ml-2"></span> </div>
                                <div class="progress-container">
                                    <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="pasteContentArea" class="input-tab-content hidden">
                    <div class="glass-card p-6">
                        <label for="xmlTextArea" class="block text-sm font-medium text-gray-300 mb-2">Paste Nmap XML Content Here:</label>
                        <textarea id="xmlTextArea" rows="15" class="w-full p-3 rounded-lg bg-gray-900 border border-gray-700 focus:ring-1 focus:ring-primary-light focus:border-primary-light outline-none text-xs font-mono custom-scrollbar resize-vertical text-gray-200 placeholder-gray-500" placeholder="<?xml...."></textarea>
                        <div class="mt-4 text-right">
                            <button id="processPasteBtn" class="btn btn-primary"> <i class='bx bx-play-circle mr-2'></i>Process Pasted XML </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="results" class="results-container">
            <div id="mainTabButtons" class="main-tab-buttons flex border-b border-gray-800 mb-0"> <button class="main-tab-button flex items-center active" data-target="scanSummaryContent"> <i class="bx bx-file-find mr-2"></i> Scan Summary & Details </button> <button class="main-tab-button flex items-center" data-target="exploitSuggesterContent"> <i class="bx bx-bug mr-2"></i> Exploit Suggester </button> </div>

            <div class="main-tab-content-area">

                <div id="scanSummaryContent" class="main-tab-content tab-content active">
                    <div id="scanSummary" class="glass-card scan-info-card mb-6">
                        <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Overall Scan Summary</h2> <span id="totalHosts" class="text-gray-400 text-lg"></span>
                        </div>
                        <div id="scanInfoGrid" class="scan-info-grid"></div>
                    </div>

                    <div class="flex items-center justify-between mb-4 flex-wrap gap-4 view-switcher">
                        <div class="flex flex-wrap space-x-2 border border-gray-700 rounded-lg p-1"> <button id="viewCardBtn" class="px-3 py-1 rounded-md text-sm font-medium transition-colors bg-primary-light text-white" data-view="card"> <i class="bx bx-grid-alt mr-1"></i> Card View </button> <button id="viewTableBtn" class="px-3 py-1 rounded-md text-sm font-medium transition-colors text-gray-400 hover:bg-gray-700 hover:text-white" data-view="table"> <i class="bx bx-table mr-1"></i> Table View </button> </div>
                        <div></div>
                    </div>

                    <div id="paginationControls" class="flex flex-wrap gap-y-2 gap-x-4 justify-center sm:justify-between items-center mb-4 px-2" style="display: none;"> <button id="prevPageBtn" class="btn btn-outline py-1 px-3 text-sm" disabled> <i class="bx bx-chevron-left mr-1"></i> Previous </button> <span id="pageInfo" class="text-sm text-gray-400 order-last sm:order-none w-full sm:w-auto text-center">Page 1 of 1</span> <button id="nextPageBtn" class="btn btn-outline py-1 px-3 text-sm" disabled> Next <i class="bx bx-chevron-right ml-1"></i> </button> </div>

                    <div id="hostResultsCards" class="space-y-6">
                        <p class="text-gray-400 text-center p-4">Loading Card View...</p>
                    </div>

                    <div id="hostResultsTableContainer" class="space-y-4 hidden">
                        <div class="glass-card p-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4"> <input type="text" id="filterIp" placeholder="Filter IP/Host..." class="filter-input bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:ring-1 focus:ring-primary-light focus:border-primary-light outline-none"> <input type="text" id="filterPort" placeholder="Filter Port..." class="filter-input bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:ring-1 focus:ring-primary-light focus:border-primary-light outline-none"> <input type="text" id="filterService" placeholder="Filter Service..." class="filter-input bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:ring-1 focus:ring-primary-light focus:border-primary-light outline-none"> <input type="text" id="filterProduct" placeholder="Filter Product/Version..." class="filter-input bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:ring-1 focus:ring-primary-light focus:border-primary-light outline-none"> </div>
                            <div class="flex flex-wrap gap-y-2 justify-between items-center">
                                <div class="flex flex-wrap gap-2"> <button id="copyFilteredIpsBtn" class="btn btn-secondary py-1 px-3 text-sm"> <i class="bx bx-copy mr-1"></i> Copy Filtered IPs </button> <button id="copyIpPortBtn" class="btn btn-secondary py-1 px-3 text-sm"> <i class="bx bx-copy-alt mr-1"></i> Copy IP:Port </button> </div> <span id="filteredRowCount" class="text-sm text-gray-400 flex-shrink-0"></span>
                            </div>
                        </div>
                        <div class="overflow-x-auto custom-scrollbar glass-card">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-800 bg-opacity-50 text-xs">
                                    <tr>
                                        <th scope="col" class="px-2 sm:px-4 py-2 text-left font-medium text-gray-300 uppercase tracking-wider">Host IP</th>
                                        <th scope="col" class="hidden sm:table-cell px-2 sm:px-4 py-2 text-left font-medium text-gray-300 uppercase tracking-wider">Hostname</th>
                                        <th scope="col" class="px-2 sm:px-4 py-2 text-left font-medium text-gray-300 uppercase tracking-wider">Port</th>
                                        <th scope="col" class="hidden sm:table-cell px-2 sm:px-4 py-2 text-left font-medium text-gray-300 uppercase tracking-wider">Proto</th>
                                        <th scope="col" class="px-2 sm:px-4 py-2 text-left font-medium text-gray-300 uppercase tracking-wider">State</th>
                                        <th scope="col" class="px-2 sm:px-4 py-2 text-left font-medium text-gray-300 uppercase tracking-wider">Service</th>
                                        <th scope="col" class="px-2 sm:px-4 py-2 text-left font-medium text-gray-300 uppercase tracking-wider">Product / Version</th>
                                    </tr>
                                </thead>
                                <tbody id="hostResultsTableBody" class="divide-y divide-gray-800">
                                    <tr>
                                        <td colspan="7" class="text-center p-4 text-gray-400">Loading Table View...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="exploitSuggesterContent" class="main-tab-content tab-content">
                    <h2 class="text-2xl font-bold mb-4">Exploit Suggester</h2>
                    <div id="exploitLoader" class="text-center py-10 hidden">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-light"></div>
                        <p id="exploitLoaderStatus" class="mt-4 text-gray-400">Analyzing Nmap data...</p>
                        <div class="w-full max-w-md mx-auto mt-4 bg-gray-700 rounded-full h-2.5">
                            <div id="exploitProgressBar" class="bg-gradient-to-r from-primary-light to-secondary-light h-2.5 rounded-full transition-width duration-300 ease-linear" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="exploitList" class="space-y-6">
                        <p class="text-gray-400 placeholder-text">Upload or paste scan data first.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="notification" class="notification">
        <div class="flex items-center"> <i id="notificationIcon" class="bx text-xl mr-2"></i> <span id="notificationText">Notification message</span> </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const browseButton = document.getElementById('browseButton');
            const sampleButton = document.getElementById('sampleButton');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const resultsContainer = document.getElementById('results');
            const uploaderSection = document.getElementById('uploader');
            const notification = document.getElementById('notification');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationText = document.getElementById('notificationText');
            const scanSummaryContent = document.getElementById('scanSummaryContent');
            const scanInfoGrid = document.getElementById('scanInfoGrid');
            const totalHosts = document.getElementById('totalHosts');
            const clearResultsTop = document.getElementById('clearResultsTop');
            const exploitSuggesterContent = document.getElementById('exploitSuggesterContent');
            const exploitList = document.getElementById('exploitList');
            const exploitLoader = document.getElementById('exploitLoader');
            const mainTabButtonsContainer = document.getElementById('mainTabButtons');
            const mainTabButtons = mainTabButtonsContainer.querySelectorAll('.main-tab-button');
            const mainTabContents = resultsContainer.querySelectorAll('.main-tab-content');
            const pocModal = document.getElementById('pocModal');
            const closePocModalBtn = document.getElementById('closePocModal');
            const pocLoadingEl = document.getElementById('pocLoading');
            const pocErrorEl = document.getElementById('pocError');
            const pocCodeContentEl = document.getElementById('pocCodeContent');
            const copyPocButton = document.getElementById('copyPocButton');
            const exploitListDiv = document.getElementById('exploitList');

            const hostResultsCards = document.getElementById('hostResultsCards');
            const hostResultsTableContainer = document.getElementById('hostResultsTableContainer');
            const hostResultsTableBody = document.getElementById('hostResultsTableBody');
            const viewCardBtn = document.getElementById('viewCardBtn');
            const viewTableBtn = document.getElementById('viewTableBtn');
            const filterIpInput = document.getElementById('filterIp');
            const filterPortInput = document.getElementById('filterPort');
            const filterServiceInput = document.getElementById('filterService');
            const filterProductInput = document.getElementById('filterProduct');
            const copyFilteredIpsBtn = document.getElementById('copyFilteredIpsBtn');
            const copyIpPortBtn = document.getElementById('copyIpPortBtn');
            const filteredRowCountSpan = document.getElementById('filteredRowCount');

            const paginationControls = document.getElementById('paginationControls');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const pageInfoSpan = document.getElementById('pageInfo');

            const tabUploadFile = document.getElementById('tabUploadFile');
            const tabPasteContent = document.getElementById('tabPasteContent');
            const uploadFileContent = document.getElementById('uploadFileContent');
            const pasteContentArea = document.getElementById('pasteContentArea');
            const xmlTextArea = document.getElementById('xmlTextArea');
            const processPasteBtn = document.getElementById('processPasteBtn');

            let parsedNmapData = null;
            let notificationTimeout;
            let pollingIntervalId = null;
            let currentView = 'card';
            let fullFilteredHostData = [];
            let currentPage = 1;
            const itemsPerPage = 50;

            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            let loadedFromStorage = false;
            try {
                const storedScanData = localStorage.getItem('nmapScanData');
                const storedExploitData = localStorage.getItem('nmapExploitData');
                if (storedScanData && storedExploitData) {
                    console.log("Found data in localStorage...");
                    const parsedScan = JSON.parse(storedScanData);
                    const parsedExploits = JSON.parse(storedExploitData);
                    if (typeof parsedScan === 'object' && parsedScan !== null && typeof parsedExploits === 'object' && parsedExploits !== null) {
                        parsedNmapData = parsedScan;
                        console.log("Parsed data from localStorage.");
                        renderParsedData(parsedNmapData);
                        populateExploitSuggesterGrouped(parsedExploits);
                        showResults();
                        loadedFromStorage = true;
                    } else {
                        console.warn("Stored data format mismatch.");
                        localStorage.removeItem('nmapScanData');
                        localStorage.removeItem('nmapExploitData');
                    }
                } else {
                    console.log("No complete data in localStorage.");
                    if (!storedScanData) localStorage.removeItem('nmapExploitData');
                    if (!storedExploitData) localStorage.removeItem('nmapScanData');
                }
            } catch (e) {
                console.error("Error parsing localStorage data:", e);
                localStorage.removeItem('nmapScanData');
                localStorage.removeItem('nmapExploitData');
            }

            function openPocModal() {
                if (!pocModal) return;
                if (pocCodeContentEl) {
                    pocCodeContentEl.textContent = '';
                    pocCodeContentEl.removeAttribute('data-highlighted');
                    pocCodeContentEl.className = 'whitespace-pre break-words';
                }
                if (pocErrorEl) {
                    pocErrorEl.textContent = '';
                    pocErrorEl.classList.add('hidden');
                }
                if (pocLoadingEl) pocLoadingEl.classList.remove('hidden');
                pocModal.classList.remove('hidden');
                pocModal.classList.add('flex', 'items-center');
                document.body.classList.add('modal-open');
                requestAnimationFrame(() => {
                    pocModal.classList.add('open');
                });
            }

            function closePocModal() {
                if (!pocModal) return;
                document.body.classList.remove('modal-open');
                pocModal.classList.remove('open');
                const d = 400;
                setTimeout(() => {
                    pocModal.classList.add('hidden');
                    pocModal.classList.remove('flex', 'items-center');
                    if (pocLoadingEl) pocLoadingEl.classList.add('hidden');
                    if (pocErrorEl) pocErrorEl.classList.add('hidden');
                }, d);
            }

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => {
                if (dropZone) dropZone.addEventListener(eName, preventDefaults, false);
                document.body.addEventListener(eName, preventDefaults, false);
            });
            ['dragenter', 'dragover'].forEach(eName => {
                if (dropZone) dropZone.addEventListener(eName, () => highlight(true), false);
            });
            ['dragleave', 'drop'].forEach(eName => {
                if (dropZone) dropZone.addEventListener(eName, () => highlight(false), false);
            });
            if (dropZone) dropZone.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight(active) {
                if (dropZone) dropZone.classList.toggle('active', active);
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                if (dt) handleFiles(dt.files);
            }

            function handleFileSelect(e) {
                if (e.target) handleFiles(e.target.files);
            }

            function processNmapData(fileObject) {
                if (!fileObject) {
                    showNotification("No file data provided.", true);
                    return;
                }
                console.log("Processing:", fileObject.name, fileObject.size);
                const reader = new FileReader();
                reader.onload = (e_reader) => {
                    const xmlContent = e_reader.target?.result;
                    if (!xmlContent) {
                        showNotification('File content empty/unreadable.', true);
                        resetParser();
                        return;
                    }
                    try {
                        parsedNmapData = parseNmapXML(xmlContent);
                        try {
                            localStorage.setItem('nmapScanData', JSON.stringify(parsedNmapData));
                        } catch (e) {
                            console.error("LS save error:", e);
                            showNotification("Could not save scan data.", true);
                        }
                        renderParsedData(parsedNmapData);
                        showResults();
                        if (exploitList) exploitList.innerHTML = '';
                        if (exploitLoader) exploitLoader.classList.remove('hidden');
                        const formData = new FormData();
                        formData.append('nmapFile', fileObject, fileObject.name);
                        const serverUrl = 'https://www.rootriot.xyz/api/process-nmap';
                        fetch(serverUrl, {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => {
                                if (!response.ok) {
                                    return response.json().then(errData => {
                                        throw new Error(errData.error || `Server status: ${response.status}`);
                                    }).catch(() => {
                                        throw new Error(`Server status: ${response.status}`);
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.error) throw new Error(data.error);
                                const exploitData = data.grouped_results || {};
                                try {
                                    localStorage.setItem('nmapExploitData', JSON.stringify(exploitData));
                                } catch (e) {
                                    console.error("LS exploit save error:", e);
                                    showNotification("Could not save exploit data.", true);
                                }
                                populateExploitSuggesterGrouped(exploitData);
                                showNotification('Exploit suggestions loaded.');
                            })
                            .catch(error => {
                                console.error('Exploit Fetch Error:', error);
                                showNotification(`Error fetching exploits: ${error.message}`, true);
                                localStorage.removeItem('nmapExploitData');
                                if (exploitList) exploitList.innerHTML = `<p class="text-red-500 p-4">Failed to get exploit data: ${error.message}</p>`;
                            })
                            .finally(() => {
                                if (exploitLoader) exploitLoader.classList.add('hidden');
                                setTimeout(() => {
                                    if (uploadProgress) uploadProgress.classList.add('hidden');
                                    if (progressBar) progressBar.style.width = '0%';
                                }, 500);
                            });
                    } catch (parseError) {
                        console.error("XML Parsing Error:", parseError);
                        showNotification('Error parsing XML: ' + parseError.message, true);
                        localStorage.removeItem('nmapScanData');
                        localStorage.removeItem('nmapExploitData');
                        resetParser();
                    }
                };
                reader.onerror = () => {
                    showNotification('Error reading file data.', true);
                    resetParser();
                };
                reader.readAsText(fileObject);
            }

            function handleFiles(files) {
                if (!files || files.length === 0) {
                    showNotification('No file selected.', true);
                    return;
                }
                const file = files[0];
                if (!file.type.match(/xml/i) && !file.name.toLowerCase().endsWith('.xml')) {
                    showNotification('Invalid file type.', true);
                    resetUploadState();
                    return;
                }
                showUploadProgress(file);
                processNmapData(file);
            }

            function showUploadProgress(file) {
                if (fileName) fileName.textContent = file.name;
                if (fileSize) fileSize.textContent = formatFileSize(file.size);
                if (uploadProgress) uploadProgress.classList.remove('hidden');
                if (progressBar) progressBar.style.width = '0%';
                setTimeout(() => {
                    if (progressBar) progressBar.style.width = '50%';
                }, 100);
            }

            function resetUploadState() {
                if (fileInput) fileInput.value = '';
                if (uploadProgress) uploadProgress.classList.add('hidden');
                if (progressBar) progressBar.style.width = '0%';
            }

            function parseNmapXML(xmlContent) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, 'application/xml');
                const parserError = xmlDoc.querySelector('parsererror');
                if (parserError) {
                    const e = parserError.textContent?.split('\n')[0] || 'Invalid XML format';
                    throw new Error(`XML Parsing Failed: ${e}`);
                }
                if (!xmlDoc.documentElement || xmlDoc.documentElement.nodeName !== 'nmaprun') throw new Error("Invalid Nmap XML: Missing <nmaprun> root element.");
                const nmapRun = xmlDoc.documentElement;
                const runstatsEl = xmlDoc.querySelector('runstats > finished');
                const startTimeTs = parseInt(nmapRun.getAttribute('start') || '0');
                const endTimeTs = parseInt(runstatsEl?.getAttribute('time') || '0');
                const scanInfo = {
                    scanner: nmapRun.getAttribute('scanner') || 'Nmap',
                    version: nmapRun.getAttribute('version') || 'Unknown',
                    args: nmapRun.getAttribute('args') || 'Not provided',
                    startTime: formatTimestamp(startTimeTs),
                    endTime: formatTimestamp(endTimeTs),
                    elapsed: formatElapsedTime(startTimeTs, endTimeTs),
                    scanType: getScanType(nmapRun.getAttribute('args') || '')
                };
                const hostElements = xmlDoc.querySelectorAll('host');
                const hosts = [];
                hostElements.forEach(hostEl => {
                    const statusEl = hostEl.querySelector('status');
                    const host = {
                        state: statusEl ? statusEl.getAttribute('state') : 'unknown',
                        reason: statusEl ? statusEl.getAttribute('reason') : 'unknown',
                        addresses: [],
                        hostnames: [],
                        ports: [],
                        os: {
                            matches: [],
                            fingerprint: ''
                        },
                        scripts: [],
                        extraPortsInfo: []
                    };
                    hostEl.querySelectorAll('address').forEach(el => {
                        host.addresses.push({
                            addr: el.getAttribute('addr') || 'N/A',
                            addrType: el.getAttribute('addrtype') || 'unknown',
                            vendor: el.getAttribute('vendor') || ''
                        });
                    });
                    hostEl.querySelectorAll('hostnames > hostname').forEach(el => {
                        host.hostnames.push({
                            name: el.getAttribute('name') || 'N/A',
                            type: el.getAttribute('type') || 'unknown'
                        });
                    });
                    const portsContainer = hostEl.querySelector('ports');
                    if (portsContainer) {
                        portsContainer.querySelectorAll('port').forEach(el => {
                            const st = el.querySelector('state');
                            const sv = el.querySelector('service');
                            const p = {
                                protocol: el.getAttribute('protocol') || 'unknown',
                                portid: el.getAttribute('portid') || 'N/A',
                                state: st ? st.getAttribute('state') : 'unknown',
                                reason: st ? st.getAttribute('reason') : 'unknown',
                                service: {
                                    name: sv ? sv.getAttribute('name') : '',
                                    product: sv ? sv.getAttribute('product') : '',
                                    version: sv ? sv.getAttribute('version') : '',
                                    extrainfo: sv ? sv.getAttribute('extrainfo') : '',
                                    method: sv ? sv.getAttribute('method') : '',
                                    conf: sv ? sv.getAttribute('conf') : ''
                                },
                                scripts: []
                            };
                            el.querySelectorAll('script').forEach(s => p.scripts.push({
                                id: s.getAttribute('id') || 'unknown',
                                output: s.getAttribute('output') || ''
                            }));
                            host.ports.push(p);
                        });
                        portsContainer.querySelectorAll('extraports').forEach(el => {
                            const x = {
                                state: el.getAttribute('state') || 'unknown',
                                count: el.getAttribute('count') || '0',
                                reasons: []
                            };
                            el.querySelectorAll('extrareasons').forEach(r => x.reasons.push({
                                reason: r.getAttribute('reason') || 'unknown',
                                count: r.getAttribute('count') || '0',
                                proto: r.getAttribute('proto') || 'unknown',
                                ports: r.getAttribute('ports') || ''
                            }));
                            host.extraPortsInfo.push(x);
                        });
                    }
                    const osContainer = hostEl.querySelector('os');
                    if (osContainer) {
                        osContainer.querySelectorAll('osmatch').forEach(el => {
                            host.os.matches.push({
                                name: el.getAttribute('name') || 'Unknown OS',
                                accuracy: el.getAttribute('accuracy') || '0',
                                line: el.getAttribute('line') || '',
                                osclasses: Array.from(el.querySelectorAll('osclass')).map(oc => ({
                                    type: oc.getAttribute('type') || '',
                                    vendor: oc.getAttribute('vendor') || '',
                                    osfamily: oc.getAttribute('osfamily') || '',
                                    osgen: oc.getAttribute('osgen') || '',
                                    accuracy: oc.getAttribute('accuracy') || ''
                                }))
                            });
                        });
                        const f = osContainer.querySelector('osfingerprint');
                        if (f) host.os.fingerprint = f.getAttribute('fingerprint') || '';
                    }
                    hostEl.querySelectorAll('hostscript > script').forEach(el => {
                        host.scripts.push({
                            id: el.getAttribute('id') || 'unknown',
                            output: el.getAttribute('output') || ''
                        });
                    });
                    hosts.push(host);
                });
                return {
                    scanInfo,
                    hosts
                };
            }

            function formatTimestamp(t) {
                if (typeof t !== 'number' || isNaN(t) || t <= 0) return 'Unknown';
                try {
                    const d = new Date(t * 1000);
                    return isNaN(d.getTime()) ? 'Invalid Date' : d.toLocaleString();
                } catch (e) {
                    return 'Invalid Date';
                }
            }

            function formatElapsedTime(s, e) {
                if (typeof s !== 'number' || typeof e !== 'number' || isNaN(s) || isNaN(e) || s <= 0 || e <= 0 || e < s) return 'Unknown';
                const sec = e - s;
                if (sec < 0) return 'Invalid Range';
                const h = Math.floor(sec / 3600),
                    m = Math.floor((sec % 3600) / 60),
                    sc = Math.floor(sec % 60);
                let r = '';
                if (h > 0) r += `${h}h `;
                if (m > 0 || h > 0) r += `${m}m `;
                r += `${sc}s`;
                return r.trim() || '0s';
            }

            function getScanType(a) {
                if (!a) return 'Unknown';
                if (a.includes('-A')) return 'Aggressive (-A)';
                if (a.includes('-sS')) return 'SYN Scan (-sS)';
                if (a.includes('-sT')) return 'TCP Connect (-sT)';
                if (a.includes('-sU')) return 'UDP Scan (-sU)';
                if (a.includes('-sV')) return 'Version Detect (-sV)';
                if (a.includes('-O')) return 'OS Detect (-O)';
                if (a.includes('-sn') || a.includes('-sP')) return 'Ping Scan (-sn/-sP)';
                let t = 'Custom';
                if (a.includes('-sTU')) t = 'TCP/UDP';
                else if (a.includes('-p ')) t = 'Specific Port';
                return t + ' Scan';
            }

            function formatFileSize(b) {
                if (b === 0) return '0 Bytes';
                const k = 1024,
                    s = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                if (isNaN(b) || b < 0) return 'Invalid size';
                const i = Math.floor(Math.log(b) / Math.log(k)),
                    idx = Math.min(i, s.length - 1);
                return parseFloat((b / Math.pow(k, idx)).toFixed(2)) + ' ' + s[idx];
            }

            function escapeHTML(s) {
                if (typeof s !== 'string') return String(s);
                const d = document.createElement('div');
                d.textContent = s;
                return d.innerHTML;
            }

            function renderParsedData(pData) {
                if (!pData) {
                    console.error("renderParsedData: No data");
                    return;
                }
                const {
                    scanInfo,
                    hosts
                } = pData;
                renderScanInfo(scanInfo, hosts.length);
                renderHostCards(hosts);
                handleFilterChange();
                updateViewVisibility();
            }

            function renderScanInfo(scanInfo, hostCount) {
                if (!scanInfoGrid) return;
                try {
                    scanInfoGrid.innerHTML = '';
                    if (totalHosts) totalHosts.textContent = `${hostCount} host(s) scanned`;
                } catch (e) {}
                scanInfo = scanInfo || {};
                const items = [{
                    l: 'Scanner',
                    v: `${scanInfo.scanner||'N/A'} ${scanInfo.version||'N/A'}`
                }, {
                    l: 'Scan Type',
                    v: scanInfo.scanType || 'Unknown'
                }, {
                    l: 'Start Time',
                    v: scanInfo.startTime || 'Unknown'
                }, {
                    l: 'End Time',
                    v: scanInfo.endTime || 'Unknown'
                }, {
                    l: 'Duration',
                    v: scanInfo.elapsed || 'Unknown'
                }, {
                    l: 'Command',
                    v: scanInfo.args || 'Not provided',
                    c: true,
                    fw: true
                }];
                items.forEach(i => {
                    try {
                        const item = document.createElement('div');
                        item.className = 'info-item';
                        if (i.fw) item.style.gridColumn = '1/-1';
                        const l = document.createElement('div');
                        l.className = 'info-label';
                        l.textContent = i.l;
                        const v = document.createElement('div');
                        v.className = 'info-value';
                        if (i.c) {
                            const c = document.createElement('code');
                            c.className = 'text-xs break-words block bg-dark p-2 rounded';
                            c.textContent = i.v;
                            v.appendChild(c);
                        } else {
                            v.textContent = escapeHTML(i.v);
                        }
                        item.appendChild(l);
                        item.appendChild(v);
                        scanInfoGrid.appendChild(item);
                    } catch (e) {}
                });
            }

            function renderHostCards(hosts) {
                if (!hostResultsCards) return;
                hostResultsCards.innerHTML = '';
                const totalItems = hosts ? hosts.length : 0;
                updatePaginationControls(totalItems);
                if (totalItems === 0) {
                    hostResultsCards.innerHTML = '<div class="glass-card p-6 text-center"><p class="text-gray-400">No hosts found.</p></div>';
                    return;
                }
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageHosts = hosts.slice(startIndex, endIndex);
                pageHosts.forEach((host, index) => {
                    try {
                        const hostIndexInFullList = startIndex + index;
                        const hostCard = document.createElement('div');
                        hostCard.className = 'glass-card host-card';
                        const hostHeader = document.createElement('div');
                        hostHeader.className = 'flex flex-wrap items-center mb-6 gap-4';
                        const avatar = document.createElement('div');
                        avatar.className = 'avatar-container';
                        avatar.innerHTML = '<i class="bx bx-server text-2xl text-primary-light"></i>';
                        const title = document.createElement('div');
                        const ip = host.addresses.find(a => a.addrType === 'ipv4')?.addr || host.addresses[0]?.addr || 'Unknown IP';
                        const hn = host.hostnames.find(h => h.type === 'user')?.name || host.hostnames.find(h => h.type === 'PTR')?.name || '';
                        title.innerHTML = `<h3 class="text-xl font-semibold">${escapeHTML(ip)}</h3>${hn?`<p class="text-sm text-gray-400">${escapeHTML(hn)}</p>`:''}`;
                        const status = document.createElement('div');
                        const sc = `status-${host.state?.replace('|','-')||'unknown'}`;
                        status.className = `ml-auto status-badge ${sc}`;
                        status.textContent = escapeHTML(host.state || 'unknown');
                        hostHeader.appendChild(avatar);
                        hostHeader.appendChild(title);
                        hostHeader.appendChild(status);
                        hostCard.appendChild(hostHeader);
                        const details = document.createElement('div');
                        details.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-sm';
                        const ips = host.addresses.filter(a => a.addrType === 'ipv4' || a.addrType === 'ipv6');
                        const mac = host.addresses.find(a => a.addrType === 'mac');
                        if (ips.length > 0) {
                            const d = document.createElement('div');
                            d.innerHTML = `<strong class="text-gray-400">IPs:</strong><br>` + ips.map(i => escapeHTML(i.addr)).join('<br>');
                            details.appendChild(d);
                        }
                        if (mac) {
                            const d = document.createElement('div');
                            d.innerHTML = `<strong class="text-gray-400">MAC:</strong><br>${escapeHTML(mac.addr)} ${mac.vendor?`(${escapeHTML(mac.vendor)})`:''}`;
                            details.appendChild(d);
                        }
                        if (details.hasChildNodes()) hostCard.appendChild(details);
                        const tabsContainer = document.createElement('div');
                        tabsContainer.className = 'mt-6 tabs-container';
                        const tabButtons = document.createElement('div');
                        tabButtons.className = 'flex border-b border-gray-800 mb-4 overflow-x-auto custom-scrollbar pb-px';
                        const availableTabs = [];
                        if (host.ports?.length > 0 || host.extraPortsInfo?.length > 0) availableTabs.push({
                            id: `ports-${hostIndexInFullList}`,
                            l: 'Ports',
                            i: 'bx-network-chart'
                        });
                        if (host.os?.matches?.length > 0 || host.os?.fingerprint) availableTabs.push({
                            id: `os-${hostIndexInFullList}`,
                            l: 'OS',
                            i: 'bx-laptop'
                        });
                        if (host.scripts?.length > 0) availableTabs.push({
                            id: `scripts-${hostIndexInFullList}`,
                            l: 'Host Scripts',
                            i: 'bx-code-block'
                        });
                        if (availableTabs.length === 0) {
                            tabsContainer.innerHTML = '<p class="text-gray-500 text-center p-4">No detailed info.</p>';
                        } else {
                            availableTabs.forEach((t, i) => {
                                const b = document.createElement('button');
                                b.className = `tab-button flex-shrink-0 flex items-center ${i===0?'active':''}`;
                                b.innerHTML = `<i class="bx ${t.i} mr-2"></i> ${escapeHTML(t.l)}`;
                                b.dataset.target = `${t.id}-content`;
                                b.addEventListener('click', (e) => {
                                    const cb = e.currentTarget;
                                    const pTC = cb?.closest('.tabs-container');
                                    const pFC = cb?.closest('.flex');
                                    if (pTC && pFC) {
                                        pFC.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                                        pTC.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                                        cb.classList.add('active');
                                        const tC = document.getElementById(cb.dataset.target || '');
                                        if (tC) tC.classList.add('active');
                                    }
                                });
                                tabButtons.appendChild(b);
                            });
                            tabsContainer.appendChild(tabButtons);
                            availableTabs.forEach((t, i) => {
                                const c = document.createElement('div');
                                c.id = `${t.id}-content`;
                                c.className = `tab-content ${i===0?'active':''}`;
                                if (t.id.startsWith('ports')) c.appendChild(renderPortsSection(host.ports || [], host.extraPortsInfo || []));
                                else if (t.id.startsWith('os')) c.appendChild(renderOSDetection(host.os || {
                                    matches: [],
                                    fingerprint: ''
                                }));
                                else if (t.id.startsWith('scripts')) c.appendChild(renderScripts(host.scripts || [], 'Host Scripts'));
                                tabsContainer.appendChild(c);
                            });
                        }
                        hostCard.appendChild(tabsContainer);
                        hostResultsCards.appendChild(hostCard);
                    } catch (e) {
                        console.error("Error rendering host card:", e, host);
                    }
                });
            }

            function renderPortsSection(ports, extraPortsInfo) {
                const c = document.createElement('div');
                if (ports.length > 0) {
                    try {
                        c.appendChild(renderPortsTableForCard(ports));
                    } catch (e) {
                        console.error("Ports table render error:", e);
                        c.innerHTML = '<p class="text-red-500">Error displaying ports.</p>';
                    }
                }
                if (extraPortsInfo.length > 0) {
                    const ex = document.createElement('div');
                    ex.className = 'extra-ports-info';
                    ex.innerHTML = '<h4 class="font-medium mb-2 text-gray-300">Summarized Port States:</h4>';
                    const l = document.createElement('ul');
                    l.className = 'list-disc list-inside space-y-1';
                    extraPortsInfo.forEach(info => {
                        const li = document.createElement('li');
                        const co = escapeHTML(info.count || '0'),
                            st = escapeHTML(info.state || 'unknown');
                        const fR = info.reasons?.[0];
                        const re = fR?.reason ? `(${escapeHTML(fR.reason)})` : '';
                        const pr = fR?.proto ? escapeHTML(fR.proto.toUpperCase()) : '';
                        li.innerHTML = `<span class="font-semibold">${co}</span> ${pr} port(s) reported as <span class="font-semibold">${st}</span> ${re}`;
                        l.appendChild(li);
                    });
                    ex.appendChild(l);
                    c.appendChild(ex);
                }
                if (ports.length === 0 && extraPortsInfo.length === 0) c.innerHTML = '<p class="text-gray-400 text-center p-4">No port information.</p>';
                return c;
            }

            function renderPortsTableForCard(ports) {
                const c = document.createElement('div');
                c.className = 'overflow-x-auto custom-scrollbar';
                const t = document.createElement('div');
                t.className = 'w-full border border-gray-800 rounded-lg overflow-hidden divide-y divide-gray-800';
                const h = document.createElement('div');
                h.className = 'hidden md:grid md:grid-cols-12 gap-2 bg-gray-800 bg-opacity-50 p-3 text-sm font-semibold';
                h.innerHTML = `<div class="md:col-span-1">Port</div><div class="md:col-span-1">Proto</div><div class="md:col-span-2">State</div><div class="md:col-span-2">Service</div><div class="md:col-span-6">Details/Scripts</div>`;
                t.appendChild(h);
                ports.sort((a, b) => parseInt(a.portid || '0') - parseInt(b.portid || '0')).forEach(p => {
                    const r = document.createElement('div');
                    r.className = 'grid grid-cols-6 md:grid-cols-12 gap-x-2 gap-y-1 md:gap-y-0 p-3 port-row text-sm items-start';
                    try {
                        const pID = document.createElement('div');
                        pID.className = 'col-span-3 md:col-span-1 font-medium';
                        pID.innerHTML = `<span class="md:hidden text-gray-400 text-xs mr-1">Port:</span> ${escapeHTML(p.portid||'N/A')}`;
                        r.appendChild(pID);
                        const pD = document.createElement('div');
                        pD.className = 'col-span-3 md:col-span-1 text-gray-400 text-right md:text-left';
                        pD.innerHTML = `<span class="md:hidden text-gray-400 text-xs mr-1">Proto:</span> ${escapeHTML(p.protocol||'unk')}`;
                        r.appendChild(pD);
                        const sC = document.createElement('div');
                        sC.className = 'col-span-full md:col-span-2';
                        const sCl = `status-${p.state?.replace('|','-')||'unknown'}`;
                        sC.innerHTML = `<span class="md:hidden text-gray-400 text-xs mr-1">State:</span> <span class="status-badge ${sCl}">${escapeHTML(p.state||'unknown')}</span>`;
                        r.appendChild(sC);
                        const svC = document.createElement('div');
                        svC.className = 'col-span-full md:col-span-2';
                        svC.innerHTML = `<span class="md:hidden text-gray-400 text-xs mr-1">Service:</span> `;
                        if (p.service?.name) {
                            const svB = document.createElement('span');
                            svB.className = 'service-badge';
                            svB.textContent = escapeHTML(p.service.name);
                            svC.appendChild(svB);
                        } else {
                            const dS = document.createElement('span');
                            dS.className = 'text-gray-500';
                            dS.textContent = '-';
                            svC.appendChild(dS);
                        }
                        r.appendChild(svC);
                        const dC = document.createElement('div');
                        dC.className = 'col-span-full md:col-span-6 space-y-2 pt-1 md:pt-0';
                        const dP = [];
                        if (p.service?.product) dP.push(escapeHTML(p.service.product));
                        if (p.service?.version) dP.push(`v${escapeHTML(p.service.version)}`);
                        if (p.service?.extrainfo) dP.push(`(${escapeHTML(p.service.extrainfo)})`);
                        if (dP.length > 0) {
                            const dT = document.createElement('div');
                            dT.innerHTML = `<span class="md:hidden text-gray-400 text-xs mr-1">Details:</span> ${dP.join(' ')}`;
                            dC.appendChild(dT);
                        }
                        if (p.scripts && p.scripts.length > 0) {
                            const sL = document.createElement('div');
                            sL.className = 'md:hidden text-gray-400 text-xs mt-1';
                            sL.textContent = 'Scripts:';
                            dC.appendChild(sL);
                            const sOE = renderScriptOutput(p.scripts);
                            const acc = createAccordion(`Script Output (${p.scripts.length})`, sOE);
                            dC.appendChild(acc);
                        }
                        if (dC.childNodes.length === 0) {
                            dC.innerHTML = `<span class="md:hidden text-gray-400 text-xs mr-1">Details:</span> <span class="text-gray-500">-</span>`;
                        }
                        r.appendChild(dC);
                        t.appendChild(r);
                    } catch (e) {
                        console.error("Error rendering port row:", e, p);
                    }
                });
                c.appendChild(t);
                return c;
            }

            function renderOSDetection(osInfo) {
                const c = document.createElement('div');
                if (osInfo.matches.length === 0 && !osInfo.fingerprint) {
                    c.innerHTML = '<p class="text-gray-400 text-center p-4">No OS info.</p>';
                    return c;
                }
                if (osInfo.matches.length > 0) {
                    const t = document.createElement('h4');
                    t.className = 'font-medium mb-2 text-gray-300';
                    t.textContent = 'OS Matches:';
                    c.appendChild(t);
                    osInfo.matches.forEach(os => {
                        const m = document.createElement('div');
                        m.className = 'os-match';
                        const h = document.createElement('div');
                        h.className = 'flex justify-between items-center mb-2';
                        h.innerHTML = `<div class="font-medium">${escapeHTML(os.name||'Unknown')}</div><div class="text-sm text-gray-400">Acc: ${escapeHTML(os.accuracy||'0')}%</div>`;
                        m.appendChild(h);
                        if (os.osclasses && os.osclasses.length > 0) {
                            const cs = document.createElement('div');
                            cs.className = 'grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs mt-3';
                            os.osclasses.forEach(cl => {
                                const d = [cl.type && `Type: ${escapeHTML(cl.type)}`, cl.vendor && `Vendor: ${escapeHTML(cl.vendor)}`, cl.osfamily && `Family: ${escapeHTML(cl.osfamily)}`, cl.osgen && `Gen: ${escapeHTML(cl.osgen)}`, cl.accuracy && `Acc: ${escapeHTML(cl.accuracy)}%`].filter(Boolean);
                                d.forEach(dt => {
                                    const dv = document.createElement('div');
                                    dv.className = 'py-1 px-2 bg-gray-800 bg-opacity-30 rounded text-gray-300 truncate';
                                    dv.title = dt;
                                    dv.textContent = dt;
                                    cs.appendChild(dv);
                                });
                            });
                            m.appendChild(cs);
                        }
                        c.appendChild(m);
                    });
                }
                if (osInfo.fingerprint) {
                    const t = document.createElement('h4');
                    t.className = 'font-medium mt-4 mb-2 text-gray-300';
                    t.textContent = 'OS Fingerprint:';
                    c.appendChild(t);
                    const fp = document.createElement('div');
                    fp.className = 'script-output text-xs custom-scrollbar';
                    fp.textContent = osInfo.fingerprint;
                    c.appendChild(fp);
                }
                return c;
            }

            function renderScripts(scripts, title) {
                const c = document.createElement('div');
                if (scripts.length === 0) {
                    c.innerHTML = `<p class="text-gray-400 text-center p-4">No ${escapeHTML(title.toLowerCase())} available.</p>`;
                    return c;
                }
                const t = document.createElement('h4');
                t.className = 'font-medium mb-2 text-gray-300';
                t.textContent = title + ':';
                c.appendChild(t);
                scripts.forEach(s => {
                    try {
                        const el = document.createElement('div');
                        el.className = 'mb-4 p-4 bg-gray-800 bg-opacity-20 rounded-lg';
                        const h = document.createElement('div');
                        h.className = 'font-medium mb-2 text-sm text-primary-light';
                        h.textContent = escapeHTML(s.id || 'unknown');
                        const ct = document.createElement('div');
                        ct.className = 'script-output custom-scrollbar';
                        ct.textContent = s.output || '';
                        el.appendChild(h);
                        el.appendChild(ct);
                        c.appendChild(el);
                    } catch (e) {}
                });
                return c;
            }

            function renderScriptOutput(scripts) {
                const c = document.createElement('div');
                c.className = 'space-y-3 py-2';
                if (!scripts || scripts.length === 0) {
                    c.innerHTML = '<p class="text-xs text-gray-500">No script output.</p>';
                    return c;
                }
                scripts.forEach(s => {
                    try {
                        const d = s || {};
                        const sid = d.id || 'unknown';
                        const sout = d.output || '';
                        const el = document.createElement('div');
                        const h = document.createElement('div');
                        h.className = 'text-xs font-medium mb-1 text-primary-light';
                        h.textContent = escapeHTML(sid);
                        const o = document.createElement('div');
                        o.className = 'script-output text-xs custom-scrollbar';
                        o.textContent = sout;
                        el.appendChild(h);
                        el.appendChild(o);
                        c.appendChild(el);
                    } catch (e) {}
                });
                return c;
            }

            function createAccordion(title, contentElement) {
                const a = document.createElement('div');
                a.className = 'mt-2 w-full';
                const h = document.createElement('div');
                h.className = 'accordion-header text-xs text-primary-light flex items-center justify-between py-1 px-2 rounded border border-transparent hover:border-primary-light hover:bg-primary-dark';
                h.innerHTML = `<span>${escapeHTML(title)}</span><i class="bx bx-chevron-right transition-transform duration-200"></i>`;
                const cD = document.createElement('div');
                cD.className = 'accordion-content mt-1 px-2';
                if (contentElement instanceof Node) {
                    cD.appendChild(contentElement);
                } else {
                    console.error("Accordion error:", contentElement);
                    cD.innerHTML = '<p class="text-xs text-red-500 p-1">Error loading content.</p>';
                }
                h.addEventListener('click', () => {
                    const chev = h.querySelector('i');
                    const isOpen = cD.classList.toggle('open');
                    if (chev) chev.style.transform = isOpen ? 'rotate(90deg)' : 'rotate(0deg)';
                    cD.style.maxHeight = isOpen ? cD.scrollHeight + "px" : '0';
                });
                a.appendChild(h);
                a.appendChild(cD);
                return a;
            }

            function filterHostData() {
             // Ensure parsed data exists
             if (!parsedNmapData || !parsedNmapData.hosts) {
                 console.warn("filterHostData called with no parsed data.");
                 return [];
             }

             // Get filter values and convert to lowercase for case-insensitive matching
             const filterIpValue = filterIpInput.value.toLowerCase().trim();
             const filterPortValue = filterPortInput.value.trim(); // Keep original case for ports initially if needed, but comparison will be exact match.
             const filterServiceValue = filterServiceInput.value.toLowerCase().trim();
             const filterProductValue = filterProductInput.value.toLowerCase().trim();

             // --- NEW: Split port and service filters by space or comma ---
             // Use a regular expression to split by one or more spaces or commas
             const portFilters = filterPortValue === '' ? [] : filterPortValue.split(/[\s,]+/).map(p => p.trim()).filter(p => p !== '');
             const serviceFilters = filterServiceValue === '' ? [] : filterServiceValue.split(/[\s,]+/).map(s => s.trim()).filter(s => s !== '');
             // --- End NEW ---

             const results = [];

             // Iterate through each host in the parsed data
             parsedNmapData.hosts.forEach(host => {
                 // Skip hosts that are not 'up' or have no ports
                 if (host.state !== 'up' || !host.ports || host.ports.length === 0) {
                     return;
                 }

                 // Get IP address (prefer IPv4) and hostname for filtering
                 const ipAddress = host.addresses?.find(a => a.addrType === 'ipv4')?.addr?.toLowerCase() || host.addresses?.[0]?.addr?.toLowerCase() || '';
                 const hostName = host.hostnames?.find(nm => nm.type === 'user' || nm.type === 'PTR')?.name?.toLowerCase() || '';

                 // Filter only open ports within the host
                 const openPorts = host.ports.filter(p => p.state === 'open');
                 if (openPorts.length === 0) {
                     return; // Skip host if no open ports
                 }

                 // Iterate through each open port of the host
                 openPorts.forEach(port => {
                     // Get port details for filtering
                     const portId = port.portid?.toLowerCase() || ''; // Port ID as string
                     const serviceName = port.service?.name?.toLowerCase() || '';
                     const productName = port.service?.product?.toLowerCase() || '';
                     const version = port.service?.version?.toLowerCase() || '';
                     const productVersionCombined = [productName, version].filter(Boolean).join(' / '); // Combine product and version

                     // --- Check filter conditions ---
                     // IP/Hostname match: Check if IP or hostname includes the filter value
                     const ipMatch = filterIpValue === '' || ipAddress.includes(filterIpValue) || hostName.includes(filterIpValue);

                     // --- UPDATED: Port match ---
                     // Check if the port ID matches any of the provided port filters (if any)
                     const portMatch = portFilters.length === 0 || portFilters.includes(portId);
                     // --- End UPDATED ---

                     // --- UPDATED: Service match ---
                     // Check if the service name matches any of the provided service filters (if any)
                     const serviceMatch = serviceFilters.length === 0 || serviceFilters.some(filter => serviceName.includes(filter));
                     // --- End UPDATED ---


                     // Product/Version match: Check if combined product/version includes the filter value
                     const productMatch = filterProductValue === '' || productVersionCombined.includes(filterProductValue);

                     // If all filter conditions are met, add the relevant data to the results array
                     if (ipMatch && portMatch && serviceMatch && productMatch) {
                         results.push({
                             ip: host.addresses?.find(a => a.addrType === 'ipv4')?.addr || host.addresses?.[0]?.addr || 'N/A',
                             hostname: host.hostnames?.find(nm => nm.type === 'user' || nm.type === 'PTR')?.name || '',
                             portid: port.portid || 'N/A',
                             protocol: port.protocol || 'N/A',
                             state: port.state || 'unknown',
                             serviceName: port.service?.name || '',
                             // Display product/version combined, keeping original case for display if needed
                             productVersionDisplay: [port.service?.product || '', port.service?.version || ''].filter(Boolean).join(' / ')
                         });
                     }
                 });
             });

             // Return the array of filtered results
             return results;
         }


            function renderHostTable(fullFilteredList) {
                if (!hostResultsTableBody) return;
                hostResultsTableBody.innerHTML = '';
                const totalItems = fullFilteredList.length;
                updatePaginationControls(totalItems);
                if (totalItems === 0) {
                    hostResultsTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-400">No hosts match filters.</td></tr>';
                    updateFilteredRowCount(0);
                    return;
                }
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageData = fullFilteredList.slice(startIndex, endIndex);
                const fragment = document.createDocumentFragment();
                pageData.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-700 hover:bg-opacity-40 transition-colors duration-150 ease-in-out text-xs sm:text-sm';
                    tr.innerHTML = ` <td class="px-2 sm:px-4 py-2 whitespace-nowrap text-light">${escapeHTML(item.ip)}</td> <td class="hidden sm:table-cell px-2 sm:px-4 py-2 whitespace-nowrap text-gray-300 truncate" title="${escapeHTML(item.hostname)}">${escapeHTML(item.hostname) || '-'}</td> <td class="px-2 sm:px-4 py-2 whitespace-nowrap text-light">${escapeHTML(item.portid)}</td> <td class="hidden sm:table-cell px-2 sm:px-4 py-2 whitespace-nowrap text-gray-400">${escapeHTML(item.protocol)}</td> <td class="px-2 sm:px-4 py-2 whitespace-nowrap"><span class="status-badge status-${escapeHTML(item.state)}">${escapeHTML(item.state)}</span></td> <td class="px-2 sm:px-4 py-2 whitespace-nowrap text-gray-300">${escapeHTML(item.serviceName) || '-'}</td> <td class="px-2 sm:px-4 py-2 whitespace-nowrap text-gray-300 truncate" title="${escapeHTML(item.productVersionDisplay)}">${escapeHTML(item.productVersionDisplay) || '-'}</td> `;
                    fragment.appendChild(tr);
                });
                hostResultsTableBody.appendChild(fragment);
                updateFilteredRowCount(totalItems);
            }

            function handleFilterChange() {
                fullFilteredHostData = filterHostData();
                currentPage = 1;
                renderHostTable(fullFilteredHostData);
            }

            function updateFilteredRowCount(count) {
                if (filteredRowCountSpan) {
                    filteredRowCountSpan.textContent = `${count} total row(s)`;
                }
            }

            function updatePaginationControls(totalItems) {
                if (!paginationControls || !prevPageBtn || !nextPageBtn || !pageInfoSpan) return;
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                if (totalPages <= 1) {
                    paginationControls.style.display = 'none';
                    return;
                }
                paginationControls.style.display = 'flex';
                pageInfoSpan.textContent = `Page ${currentPage} of ${totalPages}`;
                prevPageBtn.disabled = (currentPage === 1);
                nextPageBtn.disabled = (currentPage === totalPages);
            }

            function copyFilteredIps() {
                const d = filterHostData();
                const ips = new Set();
                if (d.length === 0) {
                    showNotification("No IPs to copy.", true);
                    return;
                }
                d.forEach(i => {
                    if (i.ip && i.ip !== 'N/A') {
                        ips.add(i.ip);
                    }
                });
                if (ips.size === 0) {
                    showNotification("No valid IPs found.", true);
                    return;
                }
                const l = Array.from(ips).join('\n');
                navigator.clipboard.writeText(l).then(() => {
                    showNotification(`Copied ${ips.size} unique IP(s).`);
                }).catch(e => {
                    console.error('Copy IP Error:', e);
                    showNotification("Failed to copy IPs.", true);
                });
            }

            function copyFilteredIpPort() {
                const d = filterHostData();
                const ipp = new Set();
                if (d.length === 0) {
                    showNotification("No results to copy.", true);
                    return;
                }
                d.forEach(i => {
                    if (i.ip && i.ip !== 'N/A' && i.portid && i.portid !== 'N/A') {
                        ipp.add(`${i.ip}:${i.portid}`);
                    }
                });
                if (ipp.size === 0) {
                    showNotification("No valid IP:Port found.", true);
                    return;
                }
                const l = Array.from(ipp).join('\n');
                navigator.clipboard.writeText(l).then(() => {
                    showNotification(`Copied ${ipp.size} unique IP:Port combinations.`);
                }).catch(e => {
                    console.error('Copy IP:Port Error:', e);
                    showNotification("Failed to copy IP:Port list.", true);
                });
            }

            function switchView(viewToShow) {
                if (viewToShow === currentView) return;
                currentView = viewToShow;
                updateViewVisibility();
                if (viewCardBtn && viewTableBtn) {
                    if (currentView === 'card') {
                        viewCardBtn.classList.add('bg-primary-light', 'text-white');
                        viewCardBtn.classList.remove('text-gray-400', 'hover:bg-gray-700', 'hover:text-white');
                        viewTableBtn.classList.remove('bg-primary-light', 'text-white');
                        viewTableBtn.classList.add('text-gray-400', 'hover:bg-gray-700', 'hover:text-white');
                    } else {
                        viewTableBtn.classList.add('bg-primary-light', 'text-white');
                        viewTableBtn.classList.remove('text-gray-400', 'hover:bg-gray-700', 'hover:text-white');
                        viewCardBtn.classList.remove('bg-primary-light', 'text-white');
                        viewCardBtn.classList.add('text-gray-400', 'hover:bg-gray-700', 'hover:text-white');
                    }
                }
            }

            function updateViewVisibility() {
                if (!hostResultsCards || !hostResultsTableContainer) return;
                currentPage = 1;
                if (currentView === 'card') {
                    hostResultsCards.classList.remove('hidden');
                    hostResultsTableContainer.classList.add('hidden');
                    renderHostCards(parsedNmapData?.hosts || []);
                } else {
                    hostResultsCards.classList.add('hidden');
                    hostResultsTableContainer.classList.remove('hidden');
                    handleFilterChange();
                }
            }

            function populateExploitSuggesterGrouped(groupedResults) {
                if (!exploitList) return;
                exploitList.innerHTML = '';
                const g = Object.keys(groupedResults);
                if (g.length === 0) {
                    exploitList.innerHTML = '<p class="text-gray-400">No open ports with potential exploits found.</p>';
                    return;
                }
                g.sort((a, b) => parseInt(a.split('/')[0]) - parseInt(b.split('/')[0]));
                g.forEach(k => {
                    const d = groupedResults[k];
                    const dv = document.createElement('div');
                    dv.className = 'exploit-group';
                    let sD = [d.service, d.product, d.version].filter(Boolean).join(' ');
                    const h3 = document.createElement('h3');
                    h3.textContent = `Port ${escapeHTML(k)} `;
                    const s = document.createElement('span');
                    s.className = "text-base font-normal text-gray-300 ml-2";
                    s.textContent = `(${escapeHTML(sD)})`;
                    h3.appendChild(s);
                    dv.appendChild(h3);
                    if (d.hosts && d.hosts.length > 0) {
                        const hC = document.createElement('div');
                        const hL = document.createElement('ul');
                        hL.className = 'exploit-hosts-list custom-scrollbar';
                        d.hosts.forEach(hI => {
                            const li = document.createElement('li');
                            li.textContent = escapeHTML(hI);
                            hL.appendChild(li);
                        });
                        hC.appendChild(hL);
                        const hA = createAccordion(`Affected Hosts (${d.hosts.length})`, hC);
                        dv.appendChild(hA);
                    }
                    if (d.exploits && d.exploits.length > 0) {
                        const eC = document.createElement('div');
                        eC.className = 'mt-4';
                        const h4 = document.createElement('h4');
                        h4.textContent = 'Potential Exploits';
                        eC.appendChild(h4);
                        const eLU = document.createElement('ul');
                        eLU.className = 'space-y-2';
                        d.exploits.forEach(ex => {
                            const li = document.createElement('li');
                            li.className = 'p-3 bg-gray-800 bg-opacity-30 rounded text-sm';
                            const tS = document.createElement('strong');
                            tS.className = 'text-secondary-light';
                            tS.textContent = ex.title;
                            li.appendChild(tS);
                            if (ex.relativePath) {
                                const pL = document.createElement('a');
                                pL.href = '#';
                                pL.textContent = 'POC';
                                pL.className = 'poc-link text-blue-400 hover:underline text-xs ml-3 cursor-pointer';
                                pL.dataset.exploitPath = ex.relativePath;
                                li.appendChild(pL);
                            } else {
                                const nPT = document.createElement('span');
                                nPT.className = 'text-xs text-gray-500 ml-3';
                                nPT.textContent = '(Path invalid/unavailable)';
                                li.appendChild(nPT);
                            }
                            eLU.appendChild(li);
                        });
                        eC.appendChild(eLU);
                        dv.appendChild(eC);
                    } else {
                        const nEM = document.createElement('p');
                        nEM.className = 'text-sm text-gray-500 mt-3';
                        nEM.textContent = 'No specific exploits correlated.';
                        dv.appendChild(nEM);
                    }
                    exploitList.appendChild(dv);
                });
            }

            function activateMainTab(targetId) {
                mainTabButtons.forEach(b => b.classList.remove('active'));
                mainTabContents.forEach(c => c.classList.remove('active'));
                const tB = mainTabButtonsContainer?.querySelector(`[data-target="${targetId}"]`);
                const tC = document.getElementById(targetId);
                if (tB) tB.classList.add('active');
                if (tC) tC.classList.add('active');
            }

            function showResults() {
                if (uploaderSection) uploaderSection.style.display = 'none';
                if (resultsContainer) resultsContainer.style.display = 'block';
                if (clearResultsTop) clearResultsTop.classList.remove('hidden');
                activateMainTab('scanSummaryContent');
                updateViewVisibility();
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }

            function resetParser() {
                localStorage.removeItem('nmapScanData');
                localStorage.removeItem('nmapExploitData');
                console.log("Cleared localStorage.");
                if (uploaderSection) uploaderSection.style.display = 'block';
                if (resultsContainer) resultsContainer.style.display = 'none';
                if (clearResultsTop) clearResultsTop.classList.add('hidden');
                resetUploadState();
                if (xmlTextArea) xmlTextArea.value = '';
                switchInputTab(tabUploadFile);
                if (scanInfoGrid) scanInfoGrid.innerHTML = '';
                if (hostResultsCards) hostResultsCards.innerHTML = '';
                if (hostResultsTableBody) hostResultsTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-400">Upload a file to view data.</td></tr>';
                if (hostResultsTableContainer) hostResultsTableContainer.classList.add('hidden');
                if (hostResultsCards) hostResultsCards.classList.remove('hidden');
                if (filterIpInput) filterIpInput.value = '';
                if (filterPortInput) filterPortInput.value = '';
                if (filterServiceInput) filterServiceInput.value = '';
                if (filterProductInput) filterProductInput.value = '';
                updateFilteredRowCount(0);
                currentPage = 1;
                fullFilteredHostData = [];
                updatePaginationControls(0);
                if (paginationControls) paginationControls.style.display = 'none';
                currentView = 'card';
                if (viewCardBtn) {
                    viewCardBtn.classList.add('bg-primary-light', 'text-white');
                    viewCardBtn.classList.remove('text-gray-400', 'hover:bg-gray-700', 'hover:text-white');
                }
                if (viewTableBtn) {
                    viewTableBtn.classList.remove('bg-primary-light', 'text-white');
                    viewTableBtn.classList.add('text-gray-400', 'hover:bg-gray-700', 'hover:text-white');
                }
                if (exploitList) exploitList.innerHTML = '<p class="text-gray-400 placeholder-text">Upload a scan file.</p>';
                if (exploitLoader) exploitLoader.classList.add('hidden');
                activateMainTab('scanSummaryContent');
                parsedNmapData = null;
                updateViewVisibility();
            }

            function showNotification(message, isError = false) {
                if (notificationTimeout) clearTimeout(notificationTimeout);
                if (notification) {
                    notification.className = `notification ${isError ? 'error' : ''}`;
                    if (notificationIcon) notificationIcon.className = `bx ${isError ? 'bx-error-circle' : 'bx-check-circle'} text-xl mr-2`;
                    if (notificationText) notificationText.textContent = message;
                    notification.classList.add('show');
                    notificationTimeout = setTimeout(() => {
                        notification.classList.remove('show');
                    }, 4000);
                }
            }

            function switchInputTab(targetTab) {
                const tabs = [tabUploadFile, tabPasteContent];
                const contents = [uploadFileContent, pasteContentArea];
                tabs.forEach((tab, index) => {
                    const content = contents[index];
                    if (tab && content) {
                        if (tab === targetTab) {
                            tab.classList.add('active');
                            content.classList.add('active');
                            content.classList.remove('hidden');
                        } else {
                            tab.classList.remove('active');
                            content.classList.remove('active');
                            content.classList.add('hidden');
                        }
                    }
                });
            }

            function loadSampleData() {
                const sampleXml = `<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE nmaprun><nmaprun scanner="nmap" args="nmap -A -T4 -oX sample_output.xml scanme.nmap.org 192.168.1.1" start="1600000000" startstr="Sun Sep 13 10:00:00 2020" version="7.80" xmloutputversion="1.04"><scaninfo type="syn" protocol="tcp" numservices="1000" services="1-1000"/><verbose level="0"/><debugging level="0"/><host starttime="1600000000" endtime="1600000100"><status state="up" reason="echo-reply" reason_ttl="53"/><address addr="45.33.32.156" addrtype="ipv4"/><address addr="00:11:22:33:44:55" addrtype="mac" vendor="Fake MAC Vendor"/><hostnames><hostname name="scanme.nmap.org" type="user"/><hostname name="scanme.nmap.org" type="PTR"/></hostnames><ports><extraports state="filtered" count="995"><extrareasons reason="no-response" count="995"/></extraports><port protocol="tcp" portid="21"><state state="open" reason="syn-ack" reason_ttl="53"/><service name="ftp" product="vsftpd" version="3.0.3" method="probed" conf="10"/></port><port protocol="tcp" portid="22"><state state="open" reason="syn-ack" reason_ttl="53"/><service name="ssh" product="OpenSSH" version="7.4p1 Debian 10+deb9u7" extrainfo="protocol 2.0" ostype="Linux" method="probed" conf="10"><cpe>cpe:/a:openbsd:openssh:7.4p1</cpe><cpe>cpe:/o:linux:linux_kernel</cpe></service><script id="ssh-hostkey" output="..."> <\/script></port><port protocol="tcp" portid="80"><state state="open" reason="syn-ack" reason_ttl="53"/><service name="http" product="Apache httpd" version="2.4.25" extrainfo="(Debian)" method="probed" conf="10"><cpe>cpe:/a:apache:http_server:2.4.25</cpe></service><script id="http-server-header" output="Apache/2.4.25 (Debian)"><elem>Apache/2.4.25 (Debian)</elem><\/script><script id="http-title" output="Go ahead and ScanMe!"><elem key="title">Go ahead and ScanMe!</elem><\/script></port><port protocol="tcp" portid="443"><state state="closed" reason="reset" reason_ttl="53"/><service name="https" method="table" conf="3"/></port><port protocol="tcp" portid="9929"><state state="open" reason="syn-ack" reason_ttl="53"/><service name="nping-echo" product="Nping echo" method="probed" conf="10"/></port></ports><os><osmatch name="Linux 3.2 - 4.9" accuracy="100"><osclass vendor="Linux" osfamily="Linux" osgen="3.X" accuracy="100"/><osclass vendor="Linux" osfamily="Linux" osgen="4.X" accuracy="100"/></osmatch></os><hostscript><script id="traceroute" output="hop 1..."/></hostscript><times srtt="90167" rttvar="1358" to="100000"/></host><host starttime="1600000101" endtime="1600000105"><status state="up" reason="conn-refused" reason_ttl="64"/><address addr="192.168.1.1" addrtype="ipv4"/><hostnames><hostname name="router.local" type="PTR"/></hostnames><ports><extraports state="closed" count="1000"><extrareasons reason="conn-refused" count="1000"/></extraports></ports><times srtt="1500" rttvar="500" to="100000"/></host><runstats><finished time="1600000105" timestr="Sun Sep 13 10:01:45 2020" elapsed="105.00" summary="Nmap done at Sun Sep 13 10:01:45 2020; 2 IP addresses (2 hosts up) scanned in 105.00 seconds" exit="success"/><hosts up="2" down="0" total="2"/></runstats></nmaprun>`;
                resetParser();
                showUploadProgress({
                    name: "sample_output.xml",
                    size: sampleXml.length
                });
                try {
                    parsedNmapData = parseNmapXML(sampleXml);
                    try {
                        localStorage.setItem('nmapScanData', JSON.stringify(parsedNmapData));
                    } catch (e) {}
                    renderParsedData(parsedNmapData);
                    setTimeout(() => {
                        if (progressBar) progressBar.style.width = '75%';
                    }, 50);
                    const sampleExploitData = handleSampleExploits(parsedNmapData);
                    if (sampleExploitData) {
                        try {
                            localStorage.setItem('nmapExploitData', JSON.stringify(sampleExploitData));
                        } catch (e) {}
                    }
                    setTimeout(() => {
                        if (progressBar) progressBar.style.width = '100%';
                        if (uploadProgress) uploadProgress.classList.add('hidden');
                        showResults();
                    }, 100);
                } catch (e) {
                    console.error("Sample Data Err:", e);
                    showNotification('Error parsing sample: ' + e.message, true);
                    localStorage.removeItem('nmapScanData');
                    localStorage.removeItem('nmapExploitData');
                    resetUploadState();
                    parsedNmapData = null;
                }
            }

            function handleSampleExploits(pData) {
                if (!pData || !pData.hosts) {
                    if (exploitList) exploitList.innerHTML = '<p class="text-yellow-500">No sample host data.</p>';
                    if (exploitLoader) exploitLoader.classList.add('hidden');
                    return null;
                }
                if (exploitList) exploitList.innerHTML = '';
                if (exploitLoader) exploitLoader.classList.remove('hidden');
                const gR = {};
                pData.hosts.forEach(h => {
                    if (h.state !== 'up') return;
                    const hId = h.addresses.find(a => a.addrType === 'ipv4')?.addr || 'Unknown';
                    h.ports.forEach(p => {
                        if (p.state !== 'open') return;
                        const pK = `${p.portid}/${p.protocol}`;
                        if (!gR[pK]) {
                            gR[pK] = {
                                service: p.service?.name || '',
                                product: p.service?.product || '',
                                version: p.service?.version || '',
                                hosts: [],
                                exploits: []
                            };
                        }
                        if (!gR[pK].hosts.includes(hId)) {
                            gR[pK].hosts.push(hId);
                        }
                        if (p.portid === '21') gR[pK].exploits.push({
                            title: 'vsftpd 3.0.3 - Backdoor (Example)',
                            relativePath: 'exploits/linux/remote/vsftpd_303_backdoor.rb'
                        });
                        if (p.portid === '22') gR[pK].exploits.push({
                            title: 'OpenSSH Username Enum (Example)',
                            relativePath: 'exploits/scanner/ssh/ssh_enumusers.py'
                        });
                        if (p.portid === '80') gR[pK].exploits.push({
                            title: 'Apache HTTP Server Generic Checks (Example)',
                            relativePath: null
                        });
                    });
                });
                setTimeout(() => {
                    populateExploitSuggesterGrouped(gR);
                    showNotification('Sample exploit suggestions loaded.');
                    if (exploitLoader) exploitLoader.classList.add('hidden');
                }, 500);
                return gR;
            }

            if (browseButton) browseButton.addEventListener('click', () => fileInput?.click());
            if (fileInput) fileInput.addEventListener('change', handleFileSelect, false);
            if (sampleButton) sampleButton.addEventListener('click', loadSampleData);
            if (clearResultsTop) clearResultsTop.addEventListener('click', resetParser);
            mainTabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetId = e.currentTarget?.dataset?.target;
                    if (targetId) activateMainTab(targetId);
                });
            });
            if (closePocModalBtn) closePocModalBtn.addEventListener('click', closePocModal);
            if (pocModal) pocModal.addEventListener('click', (event) => {
                if (event.target === pocModal) closePocModal();
            });
            if (copyPocButton && pocCodeContentEl) {
                copyPocButton.addEventListener('click', () => {
                    const codeToCopy = pocCodeContentEl.textContent || '';
                    if (!codeToCopy) {
                        showNotification("No content to copy.", true);
                        return;
                    }
                    navigator.clipboard.writeText(codeToCopy).then(() => {
                        const icon = copyPocButton.querySelector('i');
                        const textSpan = copyPocButton.querySelector('.copy-text');
                        if (icon) icon.className = 'bx bx-check mr-1';
                        if (textSpan) textSpan.textContent = ' Copied!';
                        copyPocButton.disabled = true;
                        setTimeout(() => {
                            if (icon) icon.className = 'bx bx-copy mr-1';
                            if (textSpan) textSpan.textContent = ' Copy';
                            copyPocButton.disabled = false;
                        }, 1500);
                    }).catch(err => {
                        console.error('Failed to copy PoC:', err);
                        showNotification("Failed to copy code.", true);
                    });
                });
            }
            if (exploitListDiv) {
                exploitListDiv.addEventListener('click', function(event) {
                    const target = event.target;
                    if (target.classList.contains('poc-link')) {
                        event.preventDefault();
                        const relativePath = target.dataset.exploitPath;
                        if (!relativePath) {
                            showNotification("Exploit path missing.", true);
                            return;
                        }
                        openPocModal();
                        const API_BASE_URL = 'https://www.rootriot.xyz';
                        const finalUrl = `${API_BASE_URL}/api/get-poc?path=${encodeURIComponent(relativePath)}`;
                        console.log("Fetching PoC:", finalUrl);
                        fetch(finalUrl).then(response => {
                            if (!response.ok) {
                                return response.json().then(errData => {
                                    throw new Error(errData.error || `Server error: ${response.status}`);
                                }).catch(() => {
                                    throw new Error(`Server error: ${response.status}`);
                                });
                            }
                            return response.json();
                        }).then(data => {
                            if (data.error) throw new Error(data.error);
                            if (pocCodeContentEl) {
                                pocCodeContentEl.textContent = data.content || '(Empty PoC file)';
                                if (typeof hljs !== 'undefined') hljs.highlightElement(pocCodeContentEl);
                                else console.warn("hljs not loaded");
                            } else {
                                if (pocErrorEl) {
                                    pocErrorEl.textContent = "Code display area not found.";
                                    pocErrorEl.classList.remove('hidden');
                                }
                            }
                            if (pocErrorEl) pocErrorEl.classList.add('hidden');
                        }).catch(error => {
                            console.error("PoC fetch error:", error);
                            if (pocErrorEl) {
                                pocErrorEl.textContent = `Error loading PoC: ${error.message}`;
                                pocErrorEl.classList.remove('hidden');
                            }
                            if (pocCodeContentEl) {
                                pocCodeContentEl.textContent = '';
                                pocCodeContentEl.className = 'whitespace-pre break-words';
                            }
                        }).finally(() => {
                            if (pocLoadingEl) pocLoadingEl.classList.add('hidden');
                        });
                    }
                });
            }
            if (viewCardBtn) viewCardBtn.addEventListener('click', () => switchView('card'));
            if (viewTableBtn) viewTableBtn.addEventListener('click', () => switchView('table'));
            const debouncedFilterHandler = debounce(handleFilterChange, 300);
            if (filterIpInput) filterIpInput.addEventListener('input', debouncedFilterHandler);
            if (filterPortInput) filterPortInput.addEventListener('input', debouncedFilterHandler);
            if (filterServiceInput) filterServiceInput.addEventListener('input', debouncedFilterHandler);
            if (filterProductInput) filterProductInput.addEventListener('input', debouncedFilterHandler);
            if (copyFilteredIpsBtn) copyFilteredIpsBtn.addEventListener('click', copyFilteredIps);
            if (copyIpPortBtn) copyIpPortBtn.addEventListener('click', copyFilteredIpPort);
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        if (currentView === 'card') {
                            renderHostCards(parsedNmapData?.hosts || []);
                        } else {
                            renderHostTable(fullFilteredHostData);
                        }
                    }
                });
            }
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => {
                    let totalItems = 0;
                    if (currentView === 'card') {
                        totalItems = parsedNmapData?.hosts?.length || 0;
                    } else {
                        totalItems = fullFilteredHostData.length;
                    }
                    const totalPages = Math.ceil(totalItems / itemsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        if (currentView === 'card') {
                            renderHostCards(parsedNmapData?.hosts || []);
                        } else {
                            renderHostTable(fullFilteredHostData);
                        }
                    }
                });
            }

            if (tabUploadFile) {
                tabUploadFile.addEventListener('click', () => switchInputTab(tabUploadFile));
            }
            if (tabPasteContent) {
                tabPasteContent.addEventListener('click', () => switchInputTab(tabPasteContent));
            }
            if (processPasteBtn) {
                processPasteBtn.addEventListener('click', () => {
                    const xmlContent = xmlTextArea.value;
                    const trimmedContent = xmlContent.trim();

                    if (!trimmedContent || trimmedContent.length === 0) {
                        showNotification("Please paste XML content into the text area.", true);
                        return;
                    }

                    if (!trimmedContent.toLowerCase().includes('<nmaprun')) {
                        showNotification("Content doesn't look like Nmap XML (missing <nmaprun> tag).", true);
                        return;
                    }

                    try {

                        const blob = new Blob([trimmedContent], {
                            type: 'text/xml'
                        });

                        const simulatedFile = new File([blob], 'pasted_scan.xml', {
                            type: 'text/xml'
                        });

                        if (uploadProgress) uploadProgress.classList.add('hidden');
                        if (progressBar) progressBar.style.width = '0%';

                        processNmapData(simulatedFile);

                    } catch (e) {
                        console.error("Error creating simulated file from paste:", e);
                        showNotification("Could not process pasted content.", true);
                    }
                });
            }

            if (!loadedFromStorage) {
                console.log("Initializing clean state.");
                resetParser();
            } else {
                console.log("State restored from localStorage.");
                if (clearResultsTop) clearResultsTop.classList.remove('hidden');
                updateViewVisibility();
            }

        });
    </script>

    <footer class="mt-16 text-sm">
        <div class="container">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <p class="text-gray-500 text-xs sm:text-sm order-2 md:order-1 mt-4 md:mt-0"> &copy; <span id="footer-year">2025</span> RootRiot. All rights reserved. </p>
                <div class="flex space-x-4 sm:space-x-6 order-1 md:order-2 text-xs sm:text-sm"> <a href="#" class="text-gray-500 hover:text-gray-300 transition-colors">Privacy Policy</a> <a href="#" class="text-gray-500 hover:text-gray-300 transition-colors">Terms of Service</a> <a href="#" class="text-gray-500 hover:text-gray-300 transition-colors">Cookie Policy</a> </div>
            </div>
            <p class="text-center text-gray-500 text-xs sm:text-sm mt-4"> Made with <span style="color: red;">&#10084;</span> by Aditya Singh </p>
        </div>
        <script>
            const footerYear = document.getElementById('footer-year');
            if (footerYear) footerYear.textContent = new Date().getFullYear();
        </script>
    </footer>
</body>

</html>